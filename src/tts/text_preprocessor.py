"""
æ–‡æœ¬é¢„å¤„ç†å·¥å…·
Text Preprocessing Utilities
"""
import logging
import re
from typing import List, Optional

logger = logging.getLogger(__name__)


class TextPreprocessor:
    """æ–‡æœ¬é¢„å¤„ç†å™¨"""

    # å¸¸è§è¡¨æƒ…ç¬¦å·æ˜ å°„ï¼ˆæ›¿æ¢ä¸ºä¸­æ–‡æè¿°ï¼‰
    EMOTICON_MAP = {
        "ğŸ˜Š": "å¾®ç¬‘",
        "ğŸ˜„": "å¼€å¿ƒ",
        "ğŸ˜ƒ": "é«˜å…´",
        "ğŸ˜": "å’§å˜´ç¬‘",
        "ğŸ˜†": "å¤§ç¬‘",
        "ğŸ˜…": "è‹¦ç¬‘",
        "ğŸ¤£": "ç¬‘å“­",
        "ğŸ˜‚": "ç¬‘å“­",
        "ğŸ™‚": "å¾®ç¬‘",
        "ğŸ˜‰": "çœ¨çœ¼",
        "ğŸ˜Š": "å¼€å¿ƒ",
        "ğŸ˜‡": "å¤©ä½¿",
        "ğŸ¥°": "å–œçˆ±",
        "ğŸ˜": "çˆ±å¿ƒçœ¼",
        "ğŸ¤©": "å´‡æ‹œ",
        "ğŸ˜˜": "äº²äº²",
        "ğŸ˜—": "äº²äº²",
        "ğŸ˜š": "äº²äº²",
        "ğŸ˜™": "äº²äº²",
        "ğŸ¥²": "å«æ³ªç¬‘",
        "ğŸ˜‹": "ç¾å‘³",
        "ğŸ˜›": "è°ƒçš®",
        "ğŸ˜œ": "è°ƒçš®",
        "ğŸ¤ª": "ææ€ª",
        "ğŸ˜": "è°ƒçš®",
        "ğŸ¤‘": "é’±",
        "ğŸ¤—": "æ‹¥æŠ±",
        "ğŸ¤­": "æ‚å˜´ç¬‘",
        "ğŸ¤«": "å˜˜",
        "ğŸ¤”": "æ€è€ƒ",
        "ğŸ«¡": "æ•¬ç¤¼",
        "ğŸ« ": "èåŒ–",
        "ğŸ«¢": "æƒŠè®¶",
        "ğŸ«£": "å·çœ‹",
        "ğŸ«¡": "æ•¬ç¤¼",
        "ğŸ« ": "èåŒ–",
        "ğŸ«¢": "æƒŠè®¶",
        "ğŸ«£": "å·çœ‹",
        "ğŸ¤¤": "æµå£æ°´",
        "ğŸ¤¥": "æ’’è°",
        "ğŸ˜¶": "æ— è¯­",
        "ğŸ˜¶â€ğŸŒ«ï¸": "è¿·èŒ«",
        "ğŸ«¥": "éšå½¢",
        "ğŸ˜": "é¢æ— è¡¨æƒ…",
        "ğŸ˜‘": "æ— è¯­",
        "ğŸ˜¬": "å°´å°¬",
        "ğŸ™„": "ç¿»ç™½çœ¼",
        "ğŸ˜¯": "æƒŠè®¶",
        "ğŸ˜¦": "æ‹…å¿ƒ",
        "ğŸ˜§": "æ‹…å¿ƒ",
        "ğŸ˜®": "æƒŠè®¶",
        "ğŸ˜²": "éœ‡æƒŠ",
        "ğŸ¥±": "æ‰“å“ˆæ¬ ",
        "ğŸ˜´": "ç¡è§‰",
        "ğŸ¤¤": "æµå£æ°´",
        "ğŸ˜ª": "å›°å€¦",
        "ğŸ˜µ": "æ™•",
        "ğŸ˜µâ€ğŸ’«": "æ™•å¤´è½¬å‘",
        "ğŸ« ": "èåŒ–",
        "ğŸ¤": "é—­å˜´",
        "ğŸ¥´": "æ™•",
        "ğŸ¤¢": "æ¶å¿ƒ",
        "ğŸ¤®": "å‘•å",
        "ğŸ¤§": "æ‰“å–·åš",
        "ğŸ˜·": "æˆ´å£ç½©",
        "ğŸ¤’": "ç”Ÿç—…",
        "ğŸ¤•": "å—ä¼¤",
        "ğŸ¤‘": "é’±",
        "ğŸ¤ ": "ç‰›ä»”",
        "ğŸ˜ˆ": "å°æ¶é­”",
        "ğŸ‘¿": "æ¶é­”",
        "ğŸ‘¹": "é£Ÿäººé­”",
        "ğŸ‘º": "å¤©ç‹—",
        "ğŸ¤¡": "å°ä¸‘",
        "ğŸ’©": "ä¾¿ä¾¿",
        "ğŸ‘»": "å¹½çµ",
        "ğŸ’€": "éª·é«…",
        "â˜ ï¸": "æµ·ç›—æ——",
        "ğŸ‘½": "å¤–æ˜Ÿäºº",
        "ğŸ‘¾": "å¤–æ˜Ÿæ€ªç‰©",
        "ğŸ¤–": "æœºå™¨äºº",
        "ğŸƒ": "å—ç“œç¯",
        "ğŸ˜º": "çŒ«è„¸",
        "ğŸ˜¸": "ç¬‘è„¸çŒ«",
        "ğŸ˜¹": "ç¬‘å“­çŒ«",
        "ğŸ˜»": "çˆ±å¿ƒçœ¼çŒ«",
        "ğŸ˜¼": "å¥¸ç¬‘çŒ«",
        "ğŸ˜½": "äº²äº²çŒ«",
        "ğŸ™€": "æƒŠæçŒ«",
        "ğŸ˜¿": "å“­è„¸çŒ«",
        "ğŸ˜¾": "ç”Ÿæ°”çŒ«",
        "ğŸ™ˆ": "ä¸çœ‹",
        "ğŸ™‰": "ä¸å¬",
        "ğŸ™Š": "ä¸è¯´",
        "ğŸ’‹": "å”‡å°",
        "ğŸ’Œ": "æƒ…ä¹¦",
        "ğŸ’": "æˆ’æŒ‡",
        "ğŸ’": "é’»çŸ³",
        "ğŸ’": "äº²å»",
        "ğŸ’": "èŠ±æŸ",
        "ğŸ’‘": "æƒ…ä¾£",
        "ğŸ’“": "çˆ±å¿ƒ",
        "ğŸ’”": "å¿ƒç¢",
        "ğŸ’•": "çˆ±å¿ƒ",
        "ğŸ’–": "çˆ±å¿ƒ",
        "ğŸ’—": "çˆ±å¿ƒ",
        "ğŸ’™": "è“å¿ƒ",
        "ğŸ’š": "ç»¿å¿ƒ",
        "ğŸ’›": "é»„å¿ƒ",
        "ğŸ’œ": "ç´«å¿ƒ",
        "ğŸ–¤": "é»‘å¿ƒ",
        "ğŸ¤": "ç™½å¿ƒ",
        "ğŸ¤": "æ£•å¿ƒ",
        "ğŸ’¯": "æ»¡åˆ†",
        "ğŸ’¢": "æ„¤æ€’",
        "ğŸ’¥": "çˆ†ç‚¸",
        "ğŸ’«": "æ™•",
        "ğŸ’¦": "æ±—æ°´",
        "ğŸ’¨": "çƒŸ",
        "ğŸ•³ï¸": "æ´",
        "ğŸ’£": "ç‚¸å¼¹",
        "ğŸ’¬": "å¯¹è¯æ¡†",
        "ğŸ‘ï¸â€ğŸ—¨ï¸": "è¯´è¯",
        "ğŸ—¨ï¸": "å¯¹è¯æ¡†",
        "ğŸ—¯ï¸": "æ„¤æ€’å¯¹è¯æ¡†",
        "ğŸ’­": "æ€è€ƒ",
        "ğŸ’¤": "ç¡è§‰",
        "ğŸ‘‹": "æŒ¥æ‰‹",
        "ğŸ¤š": "æ‰‹èƒŒ",
        "ğŸ–ï¸": "äº”æŒ‡",
        "âœ‹": "äº”æŒ‡",
        "ğŸ––": "ç“¦è‚¯ä¸¾æ‰‹",
        "ğŸ‘Œ": "OK",
        "ğŸ¤": "ä¸€ç‚¹ç‚¹",
        "âœŒï¸": "è€¶",
        "ğŸ¤": "äº¤å‰æ‰‹æŒ‡",
        "ğŸ¤Ÿ": "çˆ±ä½ æ‰‹åŠ¿",
        "ğŸ¤˜": "æ‘‡æ»š",
        "ğŸ¤™": "å‘¼å«",
        "ğŸ‘ˆ": "å·¦æŒ‡",
        "ğŸ‘‰": "å³æŒ‡",
        "ğŸ‘†": "ä¸ŠæŒ‡",
        "ğŸ–•": "ä¸­æŒ‡",
        "ğŸ‘‡": "ä¸‹æŒ‡",
        "â˜ï¸": "ä¸ŠæŒ‡",
        "ğŸ‘": "èµ",
        "ğŸ‘": "è¸©",
        "âœŠ": "æ‹³å¤´",
        "ğŸ‘Š": "æ‹³å¤´",
        "ğŸ¤›": "æ‹³å¤´",
        "ğŸ¤œ": "æ‹³å¤´",
        "ğŸ‘": "é¼“æŒ",
        "ğŸ™Œ": "ä¸¾èµ·åŒæ‰‹",
        "ğŸ‘": "å¼ å¼€åŒæ‰‹",
        "ğŸ¤²": "æŒå¿ƒå‘ä¸Š",
        "ğŸ¤": "æ¡æ‰‹",
        "ğŸ™": "ç¥ˆç¥·",
        "âœï¸": "å†™å­—",
        "ğŸ’ª": "è‚Œè‚‰",
        "ğŸ¦µ": "è…¿",
        "ğŸ¦¶": "è„š",
        "ğŸ‘‚": "è€³æœµ",
        "ğŸ¦»": "è€³æœµ",
        "ğŸ‘ƒ": "é¼»å­",
        "ğŸ§ ": "å¤§è„‘",
        "ğŸ«€": "å¿ƒè„",
        "ğŸ«": "è‚º",
        "ğŸ¦·": "ç‰™é½¿",
        "ğŸ¦´": "éª¨å¤´",
        "ğŸ‘€": "çœ¼ç›",
        "ğŸ‘ï¸": "çœ¼ç›",
        "ğŸ‘…": "èˆŒå¤´",
        "ğŸ‘„": "å˜´å·´",
    }

    def __init__(self, config: dict):
        """
        åˆå§‹åŒ–é¢„å¤„ç†å™¨

        Args:
            config: é…ç½®å­—å…¸
        """
        self._config = config
        self._remove_emoticons = config.get("remove_emoticons", False)
        self._normalize_numbers = config.get("normalize_numbers", True)
        self._split_long_text = config.get("split_long_text", True)
        self._max_segment_length = config.get("max_segment_length", 500)

        # æ•°å­—æ˜ å°„
        self._digit_map = {
            "0": "é›¶",
            "1": "ä¸€",
            "2": "äºŒ",
            "3": "ä¸‰",
            "4": "å››",
            "5": "äº”",
            "6": "å…­",
            "7": "ä¸ƒ",
            "8": "å…«",
            "9": "ä¹",
        }

    def preprocess(self, text: str) -> str:
        """
        é¢„å¤„ç†æ–‡æœ¬

        Args:
            text: åŸå§‹æ–‡æœ¬

        Returns:
            str: å¤„ç†åçš„æ–‡æœ¬
        """
        if not text:
            return text

        # ç§»é™¤è¡¨æƒ…ç¬¦å·ï¼ˆæˆ–æ›¿æ¢ï¼‰
        if self._remove_emoticons:
            text = self._replace_emoticons(text)

        # æ•°å­—è½¬æ–‡æœ¬
        if self._normalize_numbers:
            text = self._normalize_digit(text)

        # æ¸…ç†å¤šä½™ç©ºç™½
        text = re.sub(r'\s+', ' ', text).strip()

        # ç§»é™¤æ³¢æµªçº¿ï¼ˆé¿å… Piper å‘éŸ³å¼‚å¸¸ï¼‰
        text = text.replace('~', '').replace('ï½', '')

        return text

    def split(self, text: str) -> List[str]:
        """
        åˆ†å‰²é•¿æ–‡æœ¬

        Args:
            text: è¾“å…¥æ–‡æœ¬

        Returns:
            List[str]: æ–‡æœ¬æ®µè½
        """
        if not self._split_long_text:
            return [text]

        if len(text) <= self._max_segment_length:
            return [text]

        # æŒ‰å¥å­åˆ†å‰²
        segments = []
        current = ""

        # æŒ‰æ ‡ç‚¹ç¬¦å·åˆ†å‰²
        for char in text:
            current += char

            if char in ['ã€‚', 'ï¼', 'ï¼Ÿ', 'ï¼›', 'ï¼š']:
                if len(current) >= 10:
                    segments.append(current)
                    current = ""
            elif char in ['ï¼Œ', ',']:
                if len(current) >= self._max_segment_length:
                    segments.append(current)
                    current = ""

        # æ·»åŠ å‰©ä½™å†…å®¹
        if current:
            segments.append(current)

        return segments

    def _replace_emoticons(self, text: str) -> str:
        """æ›¿æ¢è¡¨æƒ…ç¬¦å·ä¸ºä¸­æ–‡æè¿°"""
        result = text
        for emoticon, description in self.EMOTICON_MAP.items():
            result = result.replace(emoticon, description)

        # ç§»é™¤å‰©ä½™çš„è¡¨æƒ…ç¬¦å·
        emoticon_pattern = re.compile(
            "["
            "\U0001F600-\U0001F64F"  # emoticons
            "\U0001F300-\U0001F5FF"  # symbols & pictographs
            "\U0001F680-\U0001F6FF"  # transport & map symbols
            "\U0001F1E0-\U0001F1FF"  # flags
            "\U00002702-\U000027B0"
            "\U000024C2-\U0001F251"
            "]+",
            flags=re.UNICODE
        )
        result = emoticon_pattern.sub('', result)

        return result

    def _normalize_digit(self, text: str) -> str:
        """
        æ•°å­—è½¬æ–‡æœ¬

        Args:
            text: è¾“å…¥æ–‡æœ¬

        Returns:
            str: è½¬æ¢åçš„æ–‡æœ¬
        """
        # ç®€å•å®ç°ï¼šè½¬æ¢å¸¸è§æ•°å­—
        # æ›´å¤æ‚çš„å®ç°éœ€è¦ cn2an æˆ–ç±»ä¼¼åº“
        result = text

        # æ›¿æ¢å•ä¸ªæ•°å­—ï¼ˆä½†ä¿ç•™æ—¥æœŸã€æ—¶é—´ç­‰ï¼‰
        # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼é¿å…æ›¿æ¢æ—¥æœŸã€æ—¶é—´ä¸­çš„æ•°å­—
        # è¿™é‡Œåªæ›¿æ¢ç‹¬ç«‹çš„æ•°å­—
        result = re.sub(
            r'(?<!\d)(\d)(?!\d)',
            lambda m: self._digit_map.get(m.group(1), m.group(1)),
            result
        )

        return result

    def clean_for_tts(self, text: str) -> str:
        """
        æ¸…ç†æ–‡æœ¬ä»¥ä¼˜åŒ– TTS å‘éŸ³

        Args:
            text: è¾“å…¥æ–‡æœ¬

        Returns:
            str: æ¸…ç†åçš„æ–‡æœ¬
        """
        # ç§»é™¤ Markdown æ ‡è®°
        text = re.sub(r'\*\*(.*?)\*\*', r'\1', text)  # **ç²—ä½“**
        text = re.sub(r'\*(.*?)\*', r'\1', text)  # *æ–œä½“*
        text = re.sub(r'`(.*?)`', r'\1', text)  # `ä»£ç `

        # ç§»é™¤é“¾æ¥
        text = re.sub(r'\[([^\]]+)\]\([^\)]+\)', r'\1', text)  # [æ–‡æœ¬](é“¾æ¥)

        # æ›¿æ¢å¸¸è§ç¬¦å·
        replacements = {
            '&': "å’Œ",
            '%': "ç™¾åˆ†ä¹‹",
            '/': "æˆ–",
            '+': "åŠ ",
            '=': "ç­‰äº",
            '>': "å¤§äº",
            '<': "å°äº",
        }
        for old, new in replacements.items():
            text = text.replace(old, new)

        return text

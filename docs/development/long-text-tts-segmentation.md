# 长文本 TTS 分段功能

## 功能概述

远程 TTS 引擎（GPT-SoVITS API）现在支持**智能长文本分段**：

1. **自动检测文本长度** - 超过阈值时自动触发分段
2. **智能分段策略** - 按标点符号分段，避免在句子中间断开
3. **强制切分** - 对于无标点的超长句，强制按长度切分
4. **逐段合成** - 每段独立调用 API
5. **自动合并** - 所有音频段自动合并成完整音频

---

## 分段策略

### 1. 智能分段（有标点）

按句号、问号、感叹号分段：

```
原始文本（150字）:
"你好。世界。今天天气真好。我想出去玩。但是不知道去哪里好。"

↓ 分段

段 1 (50字): "你好。世界。今天天气真好。"
段 2 (50字): "我想出去玩。但是不知道去哪里好。"
```

### 2. 强制切分（无标点）

对于没有标点的超长句，强制按长度切分：

```
原始文本（120字，无标点）:
"这是一个非常非常非常非常非常非常非常非常非常非常非常非常长的句子..."

↓ 强制切分

段 1 (100字): "这是一个非常非常非常非常非常..."
段 2 (20字):  "...长的句子剩余部分"
```

---

## 配置说明

### config.yaml

```yaml
tts:
  engine: "hybrid"  # 或 "remote"

  remote:
    server_ip: "192.168.1.100"
    max_text_length: 100  # ⭐ 单次请求最大文本长度（字）
```

### 参数说明

- **max_text_length**: 单次 API 请求的最大文本长度（字符数）
  - 默认: `100` 字
  - 推荐范围: `50-200`
  - 过小：请求次数多，延迟增加
  - 过大：可能超出 API 限制，导致超时

### 调优建议

| 场景 | 推荐值 | 说明 |
|------|--------|------|
| 短对话 | `50-100` | 快速响应，减少延迟 |
| 讲故事 | `100-200` | 平衡速度和完整性 |
| 长文档 | `200-300` | 减少分段数量 |

---

## 工作流程

### 正常流程（短文本）

```
用户输入: "你好，世界" (5字)
  ↓
检测: 5 < 100 ✅ 单次请求
  ↓
API 调用: 一次请求
  ↓
返回音频: 完整音频
```

### 分段流程（长文本）

```
用户输入: 200字的长文本
  ↓
检测: 200 > 100 ⚠️ 需要分段
  ↓
智能分段:
  段 1: 80字
  段 2: 70字
  段 3: 50字
  ↓
逐段合成:
  API 调用 1 → 音频段 1
  API 调用 2 → 音频段 2
  API 调用 3 → 音频段 3
  ↓
合并音频: numpy.concatenate([段1, 段2, 段3])
  ↓
返回完整音频
```

---

## 日志示例

### 短文本（不分段）

```
DEBUG - 远程 TTS 合成文本长度: 20 字
DEBUG - 请求远程 TTS: 你好，这是一个测试。
DEBUG - ✅ 远程 TTS 合成成功: 8000 采样点
```

### 长文本（分段）

```
INFO - 📝 文本过长 (243 字)，自动分段处理
INFO -   文本分段: 3 段
DEBUG -     段 1: 69 字 - 胡桃是往生堂第七十七代堂主...
DEBUG -     段 2: 86 字 - 在提瓦特大陆上...
DEBUG -     段 3: 79 字 - 她的命之理是「燃烧」...
INFO -   合成第 1/3 段...
DEBUG - 请求远程 TTS: 胡桃是往生堂第七十七代堂主...
DEBUG -     ✅ 第 1 段完成: 27600 采样点
INFO -   合成第 2/3 段...
DEBUG - 请求远程 TTS: 在提瓦特大陆上...
DEBUG -     ✅ 第 2 段完成: 34400 采样点
INFO -   合成第 3/3 段...
DEBUG - 请求远程 TTS: 她的命之理是「燃烧」...
DEBUG -     ✅ 第 3 段完成: 31600 采样点
INFO -   合并 3 段音频...
INFO - ✅ 长文本合成完成: 93600 采样点 (3 段)
```

---

## 测试

### 测试文件

```bash
# 测试分段逻辑
python tests/unit/test_long_text_tts.py
```

### 测试用例

1. ✅ 短文本（不需要分段）
2. ✅ 中等文本（刚好一段）
3. ✅ 长文本（多句，需要分段）
4. ✅ 超长句子（无标点，强制切分）
5. ✅ 混合文本（有标点也有长句）

---

## 性能分析

### 时间成本

| 文本长度 | 分段数 | API 调用次数 | 预估总耗时 |
|---------|--------|------------|-----------|
| 50字 | 1 | 1 | ~2秒 |
| 150字 | 2 | 2 | ~4秒 |
| 300字 | 3 | 3 | ~6秒 |

### 优化建议

1. **减少分段数**
   - 适当增加 `max_text_length`
   - 在 API 服务器能力范围内

2. **并行处理**（未来优化）
   - 多段并行调用 API
   - 需要服务器支持并发

3. **缓存优化**（未来优化）
   - 缓存常见短语的音频
   - 减少重复 API 调用

---

## 故障处理

### 分段失败

如果某一段合成失败：

```
INFO - 合成第 2/3 段...
ERROR - ❌ 第 2 段失败: ConnectionError
RuntimeError: 长文本合成失败（第 2/3 段）: ConnectionError
```

**处理策略**：
- 当前实现：抛出异常，保证完整性
- 未来优化：支持重试机制

### 超时处理

如果某段请求超时：

```
ERROR - 远程 TTS 请求超时
```

**自动处理**：
- 标记远程服务器为不可用
- 混合引擎自动切换到本地 TTS
- 后台健康检查会在 1 小时后重试

---

## API 限制

根据 GPT-SoVITS 文档：

| 指标 | 推荐值 | 说明 |
|------|--------|------|
| 单次请求长度 | <200字 | 超过可能超时 |
| 超时时间 | 60秒 | 可配置 |
| 支持语言 | zh/en/ja | 中文/英文/日文 |

---

## 代码实现

### 核心方法

```python
# 远程 TTS 引擎
class RemoteTTSEngine:
    def __init__(self, max_text_length=100):
        self._max_text_length = max_text_length

    def synthesize(self, text):
        # 检测是否需要分段
        if len(text) > self._max_text_length:
            return self._synthesize_segmented(text)
        else:
            return self._synthesize_single(text)

    def _split_text(self, text):
        # 智能分段逻辑
        # 1. 按标点分段
        # 2. 强制切分超长句
        return segments

    def _synthesize_segmented(self, text):
        # 1. 分段
        segments = self._split_text(text)
        # 2. 逐段合成
        all_audio = [self._synthesize_single(seg) for seg in segments]
        # 3. 合并音频
        return np.concatenate(all_audio)
```

---

## 常见问题

### Q1: 为什么有些文本分段后仍超过 max_text_length？

**A**: 可能是因为：
- 文本没有标点符号
- 单个句子本身就超过阈值
- 这种情况下会被强制按长度切分

### Q2: 分段会不会影响语音连贯性？

**A**:
- 按标点分段：影响很小，自然停顿
- 强制切分：可能有些突兀
- 建议：合理设置 `max_text_length`，尽量按标点分段

### Q3: 能否调整分段策略？

**A**: 当前版本固定按标点分段，未来可以支持：
- 自定义分隔符
- 分段权重策略
- 语义分析分段

---

## 相关文件

- **引擎实现**: `src/tts/remote_engine.py`
- **测试代码**: `tests/unit/test_long_text_tts.py`
- **配置文件**: `config.yaml`
- **使用文档**: `docs/development/hybrid-tts-implementation.md`

---

## 总结

✅ **功能完整**
- 自动检测文本长度
- 智能分段（标点 + 强制切分）
- 逐段合成 + 自动合并
- 完善的日志记录

✅ **易于使用**
- 配置简单（`max_text_length`）
- 自动工作，无需手动干预
- 与混合引擎无缝集成

✅ **性能优化**
- 避免超长请求超时
- 提高成功率
- 降低服务器负载

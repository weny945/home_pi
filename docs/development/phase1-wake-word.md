# ç¬¬ä¸€é˜¶æ®µå¼€å‘æ–‡æ¡£ï¼šå”¤é†’è¯æ£€æµ‹ç³»ç»Ÿ

**ç‰ˆæœ¬**: 1.0
**æ—¥æœŸ**: 2026-01-21
**çŠ¶æ€**: ğŸš§ å¼€å‘ä¸­

---

## ğŸ“‹ é˜¶æ®µç›®æ ‡

å®ç°ä»è¿œåœºè¯­éŸ³è¾“å…¥åˆ°å”¤é†’è¯æ£€æµ‹çš„å®Œæ•´é“¾è·¯ï¼š

```
ReSpeaker 4-Mic â†’ OpenWakeWord â†’ å”¤é†’æˆåŠŸ â†’ æ’­æ”¾å›å¤
```

### æ ¸å¿ƒåŠŸèƒ½
1. âœ… **ReSpeaker éŸ³é¢‘è¾“å…¥** - ä»éº¦å…‹é£é˜µåˆ—è·å–æ³¢æŸæˆå½¢éŸ³é¢‘æµ
2. âœ… **å”¤é†’è¯æ£€æµ‹** - ä½¿ç”¨ OpenWakeWord å®æ—¶æ£€æµ‹ä¸­æ–‡å”¤é†’è¯
3. âœ… **å”¤é†’åé¦ˆ** - æ£€æµ‹æˆåŠŸåæ’­æ”¾æç¤ºéŸ³æˆ–è¯­éŸ³å›å¤

### ä¸åŒ…å«åŠŸèƒ½ï¼ˆåç»­é˜¶æ®µï¼‰
- âŒ è¯­éŸ³è¯†åˆ« (STT)
- âŒ å¯¹è¯ç”Ÿæˆ (LLM)
- âŒ è¯­éŸ³åˆæˆ (TTS) - æœ¬é˜¶æ®µä½¿ç”¨ç®€å•æç¤ºéŸ³æˆ–é¢„å½•éŸ³é¢‘

---

## ğŸ¯ çŠ¶æ€æœºè®¾è®¡ï¼ˆç®€åŒ–ç‰ˆï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  IDLE   â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                  â”‚
     â”‚ æ£€æµ‹åˆ°å”¤é†’è¯          â”‚
     â–¼                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚ WAKEUP  â”‚                  â”‚
â”‚ (æ’­æ”¾   â”‚                  â”‚
â”‚  å›å¤)  â”‚                  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                  â”‚
     â”‚ æ’­æ”¾å®Œæˆ              â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### çŠ¶æ€å®šä¹‰

| çŠ¶æ€ | æè¿° | è¶…æ—¶ | è½¬æ¢æ¡ä»¶ |
|------|------|------|----------|
| **IDLE** | ç›‘å¬å”¤é†’è¯ï¼ŒæŒç»­é‡‡é›†éŸ³é¢‘ | æ—  | æ£€æµ‹åˆ°å”¤é†’è¯ â†’ WAKEUP |
| **WAKEUP** | æ’­æ”¾å”¤é†’åé¦ˆ | 5ç§’ | æ’­æ”¾å®Œæˆ â†’ IDLE |

---

## ğŸ“ æ¨¡å—ç»“æ„

```
src/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ config/                    # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ config_loader.py       # YAMLé…ç½®åŠ è½½å™¨
â”‚
â”œâ”€â”€ audio/                     # éŸ³é¢‘è¾“å…¥æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ microphone.py          # éº¦å…‹é£æŠ½è±¡å±‚
â”‚   â””â”€â”€ respeaker_input.py     # ReSpeaker 4-Mic å®ç°
â”‚
â”œâ”€â”€ wake_word/                 # å”¤é†’è¯æ£€æµ‹æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ detector.py            # æ£€æµ‹å™¨æŠ½è±¡å±‚
â”‚   â””â”€â”€ openwakeword_detector.py  # OpenWakeWord å®ç°
â”‚
â”œâ”€â”€ feedback/                  # å”¤é†’åé¦ˆæ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ player.py              # æ’­æ”¾å™¨æŠ½è±¡å±‚
â”‚   â””â”€â”€ audio_feedback.py      # éŸ³é¢‘æ’­æ”¾å®ç°
â”‚
â”œâ”€â”€ state_machine/             # çŠ¶æ€æœºæ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ states.py              # çŠ¶æ€å®šä¹‰ï¼ˆæšä¸¾ï¼‰
â”‚   â””â”€â”€ machine.py             # çŠ¶æ€æœºæ ¸å¿ƒé€»è¾‘
â”‚
â””â”€â”€ main.py                    # ä¸»å…¥å£ï¼ˆè¿ç§»åˆ°æ ¹ç›®å½•ï¼‰

tests/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ test_config.py             # é…ç½®åŠ è½½æµ‹è¯•
â”œâ”€â”€ test_audio.py              # éŸ³é¢‘è¾“å…¥æµ‹è¯•
â”œâ”€â”€ test_wake_word.py          # å”¤é†’è¯æ£€æµ‹æµ‹è¯•
â””â”€â”€ test_state_machine.py      # çŠ¶æ€æœºæµ‹è¯•
```

---

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. éŸ³é¢‘è¾“å…¥æ¨¡å—

**èŒè´£**: ä» ReSpeaker 4-Mic è·å– 16kHz å•é€šé“éŸ³é¢‘æµ

**æ¥å£è®¾è®¡**:
```python
class MicrophoneInput(ABC):
    @abstractmethod
    def start_stream(self) -> None:
        """å¯åŠ¨éŸ³é¢‘æµ"""
        pass

    @abstractmethod
    def read_chunk(self) -> np.ndarray:
        """è¯»å–ä¸€ä¸ªéŸ³é¢‘å— (chunk_size: 512 frames)"""
        pass

    @abstractmethod
    def stop_stream(self) -> None:
        """åœæ­¢éŸ³é¢‘æµ"""
        pass
```

**ä¾èµ–**:
- `pyaudio` - PortAudio Python ç»‘å®š
- `numpy` - éŸ³é¢‘æ•°æ®å¤„ç†

**ReSpeaker ç‰¹å®š**:
- è¾“å…¥è®¾å¤‡: `seeed-4mic-voicecard`
- é‡‡æ ·ç‡: 16000 Hz
- é€šé“: å•å£°é“ï¼ˆBF é€šé“ï¼Œæ³¢æŸæˆå½¢åï¼‰
- æ ¼å¼: 16-bit PCM

---

### 2. å”¤é†’è¯æ£€æµ‹æ¨¡å—

**èŒè´£**: å®æ—¶æ£€æµ‹éŸ³é¢‘æµä¸­çš„å”¤é†’è¯

**æ¥å£è®¾è®¡**:
```python
class WakeWordDetector(ABC):
    @abstractmethod
    def process_frame(self, audio_frame: np.ndarray) -> bool:
        """
        å¤„ç†éŸ³é¢‘å¸§

        Args:
            audio_frame: éŸ³é¢‘æ•°æ® (16kHz, 16bit, å•å£°é“)

        Returns:
            bool: æ˜¯å¦æ£€æµ‹åˆ°å”¤é†’è¯
        """
        pass

    @abstractmethod
    def load_model(self, model_path: str) -> None:
        """åŠ è½½å”¤é†’è¯æ¨¡å‹"""
        pass
```

**OpenWakeWord å®ç°**:
- ä½¿ç”¨å®˜æ–¹æ¨¡å‹æˆ–è‡ªå®šä¹‰è®­ç»ƒçš„ `.ppn` æ¨¡å‹
- CPU å ç”¨ < 5%
- æ£€æµ‹å»¶è¿Ÿ < 300ms
- æ”¯æŒä¸­è‹±æ–‡å”¤é†’è¯

**è®­ç»ƒè‡ªå®šä¹‰å”¤é†’è¯**:
```bash
# ä½¿ç”¨ openWakeWord è®­ç»ƒå·¥å…·
# å‚è€ƒ: https://github.com/dscripka/openWakeWord/wiki
oww train --keyword "å°æ™ºå°æ™º" --language zh
```

---

### 3. å”¤é†’åé¦ˆæ¨¡å—

**èŒè´£**: å”¤é†’æˆåŠŸåæ’­æ”¾æç¤ºéŸ³æˆ–è¯­éŸ³

**æ¥å£è®¾è®¡**:
```python
class FeedbackPlayer(ABC):
    @abstractmethod
    def play_wake_feedback(self) -> None:
        """æ’­æ”¾å”¤é†’åé¦ˆ"""
        pass

    @abstractmethod
    def is_playing(self) -> bool:
        """æ˜¯å¦æ­£åœ¨æ’­æ”¾"""
        pass
```

**ç¬¬ä¸€é˜¶æ®µå®ç°**ï¼ˆç®€åŒ–ç‰ˆï¼‰:
- æ–¹æ¡ˆ A: æ’­æ”¾èœ‚é¸£å£°ï¼ˆç®€å•ï¼Œæ— ä¾èµ–ï¼‰
- æ–¹æ¡ˆ B: æ’­æ”¾é¢„å½• WAV æ–‡ä»¶ï¼ˆéœ€è¦éŸ³é¢‘æ–‡ä»¶ï¼‰
- æ–¹æ¡ˆ C: TTS åˆæˆï¼ˆç¬¬äºŒé˜¶æ®µå®ç°ï¼‰

**æ¨è**: æ–¹æ¡ˆ A + æ–¹æ¡ˆ B ç»„åˆ
- é»˜è®¤ä½¿ç”¨èœ‚é¸£å£°
- æ”¯æŒé…ç½®è‡ªå®šä¹‰ WAV æ–‡ä»¶

---

### 4. çŠ¶æ€æœºæ¨¡å—

**èŒè´£**: ç®¡ç†ç³»ç»ŸçŠ¶æ€è½¬æ¢

**æ¥å£è®¾è®¡**:
```python
class StateMachine:
    def __init__(self):
        self.current_state: State = State.IDLE

    def transition_to(self, new_state: State) -> None:
        """çŠ¶æ€è½¬æ¢"""
        pass

    def update(self) -> None:
        """æ¯å¸§æ›´æ–°ï¼ˆåœ¨ä¸»å¾ªç¯ä¸­è°ƒç”¨ï¼‰"""
        pass
```

**çŠ¶æ€æšä¸¾**:
```python
from enum import Enum

class State(Enum):
    IDLE = "idle"           # ç›‘å¬ä¸­
    WAKEUP = "wakeup"       # å”¤é†’åé¦ˆæ’­æ”¾ä¸­
```

---

## ğŸ“ é…ç½®æ–‡ä»¶

### config.yaml (ç¬¬ä¸€é˜¶æ®µç®€åŒ–ç‰ˆ)

```yaml
# éŸ³é¢‘é…ç½®
audio:
  input_device: "seeed-4mic-voicecard"
  sample_rate: 16000
  channels: 1
  chunk_size: 512
  format: "int16"

# å”¤é†’è¯é…ç½®
wakeword:
  engine: "openwakeword"
  model: "paimon_paimon_zh.ppn"  # æˆ–ä½¿ç”¨é»˜è®¤æ¨¡å‹
  threshold: 0.5
  model_dir: "./models/openwakeword"

# å”¤é†’åé¦ˆé…ç½®
feedback:
  enabled: true
  mode: "beep"  # "beep" æˆ– "audio_file"
  audio_file: "./assets/wake_success.wav"
  beep_duration_ms: 200
  beep_frequency: 880

# æ—¥å¿—é…ç½®
logging:
  level: "INFO"
  file: "./logs/phase1.log"
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•

| æ¨¡å— | æµ‹è¯•å†…å®¹ | Mock å¯¹è±¡ |
|------|----------|-----------|
| **config** | é…ç½®åŠ è½½ã€éªŒè¯ | - |
| **audio** | éŸ³é¢‘æµè¯»å– | PyAudio |
| **wake_word** | æ£€æµ‹å™¨åˆå§‹åŒ–ã€å¤„ç† | éŸ³é¢‘æµ |
| **feedback** | æ’­æ”¾å™¨åŠŸèƒ½ | PyAudio |
| **state_machine** | çŠ¶æ€è½¬æ¢ | æ‰€æœ‰ä¾èµ– |

### é›†æˆæµ‹è¯•

```python
# æµ‹è¯•å®Œæ•´æµç¨‹
def test_wake_word_pipeline():
    # 1. åˆå§‹åŒ–æ‰€æœ‰æ¨¡å—
    # 2. æ’­æ”¾æµ‹è¯•éŸ³é¢‘ï¼ˆåŒ…å«å”¤é†’è¯ï¼‰
    # 3. éªŒè¯çŠ¶æ€è½¬æ¢: IDLE â†’ WAKEUP â†’ IDLE
    # 4. éªŒè¯åé¦ˆæ’­æ”¾
    pass
```

### ç¡¬ä»¶æµ‹è¯•ï¼ˆæ ‘è“æ´¾ï¼‰

```bash
# 1. éªŒè¯ ReSpeaker è®¾å¤‡
arecord -L | grep seeed

# 2. æµ‹è¯•éŸ³é¢‘è¾“å…¥
arecord -D seeed-4mic-voicecard -f S16_LE -r 16000 -c 1 test.wav

# 3. è¿è¡Œé›†æˆæµ‹è¯•
python tests/integration/test_hardware.py
```

---

## ğŸš€ å¼€å‘æ­¥éª¤

### Step 1: ç¯å¢ƒå‡†å¤‡
- [x] åˆ›å»ºé¡¹ç›®ç»“æ„
- [ ] å®‰è£…ä¾èµ– (`pip install pyaudio numpy openwakeword pyyaml`)
- [ ] åˆ›å»ºé…ç½®æ–‡ä»¶

### Step 2: æ ¸å¿ƒæ¨¡å—å¼€å‘
- [ ] å®ç°é…ç½®åŠ è½½å™¨
- [ ] å®ç° ReSpeaker éŸ³é¢‘è¾“å…¥
- [ ] å®ç° OpenWakeWord æ£€æµ‹å™¨
- [ ] å®ç°åé¦ˆæ’­æ”¾å™¨

### Step 3: çŠ¶æ€æœºå¼€å‘
- [ ] å®šä¹‰çŠ¶æ€æšä¸¾
- [ ] å®ç°çŠ¶æ€æœºæ ¸å¿ƒé€»è¾‘
- [ ] é›†æˆæ‰€æœ‰æ¨¡å—

### Step 4: æµ‹è¯•
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] ç¼–å†™é›†æˆæµ‹è¯•
- [ ] æ ‘è“æ´¾ç¡¬ä»¶æµ‹è¯•

### Step 5: ä¼˜åŒ–
- [ ] æ€§èƒ½æµ‹è¯•ï¼ˆCPU å ç”¨ï¼‰
- [ ] å»¶è¿Ÿæµ‹è¯•ï¼ˆå”¤é†’å“åº”æ—¶é—´ï¼‰
- [ ] é”™è¯¯å¤„ç†

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### è·¨å¹³å°å…¼å®¹æ€§

| ç¯å¢ƒ | é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| **amd64 (å¼€å‘)** | æ—  ReSpeaker ç¡¬ä»¶ | 1. ä½¿ç”¨é»˜è®¤éº¦å…‹é£æµ‹è¯•<br>2. Mock éŸ³é¢‘è¾“å…¥ |
| **arm64 (ç”Ÿäº§)** | ä¾èµ–åº“å®‰è£… | ä½¿ç”¨çº¯ Python åº“æˆ– arm64 è½®å­ |

### ä¾èµ–å®‰è£…

```bash
# amd64 å¼€å‘ç¯å¢ƒ
pip install pyaudio numpy openwakeword pyyaml

# arm64 ç”Ÿäº§ç¯å¢ƒï¼ˆæ ‘è“æ´¾ï¼‰
sudo apt install portaudio19-dev
pip install pyaudio numpy openwakeword pyyaml
```

### æ€§èƒ½ä¼˜åŒ–

- **ç¼“å†²åŒºå¤§å°**: `chunk_size=512` (32ms @ 16kHz)
- **é‡‡æ ·ç‡**: å›ºå®š 16kHz (å…¼é¡¾è´¨é‡å’Œæ€§èƒ½)
- **å¤šçº¿ç¨‹**: éŸ³é¢‘é‡‡é›†å’Œå¤„ç†åˆ†ç¦»

---

## ğŸ“Š éªŒæ”¶æ ‡å‡†

| æŒ‡æ ‡ | ç›®æ ‡ | æµ‹è¯•æ–¹æ³• |
|------|------|----------|
| **å”¤é†’ç‡** | â‰¥ 80% (3ç±³,å®‰é™) | äººå·¥æµ‹è¯• 10 æ¬¡ |
| **è¯¯æŠ¥ç‡** | < 1æ¬¡/å°æ—¶ | é•¿æ—¶é—´è¿è¡Œ |
| **CPU å ç”¨** | < 5% (IDLE) | `top` ç›‘æ§ |
| **å“åº”å»¶è¿Ÿ** | < 300ms | è®¡æ—¶æµ‹è¯• |
| **ç¨³å®šæ€§** | è¿ç»­è¿è¡Œ 1 å°æ—¶æ— å´©æºƒ | å‹åŠ›æµ‹è¯• |

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [OpenWakeWord æ–‡æ¡£](https://github.com/dscripka/openWakeWord)
- [PyAudio æ–‡æ¡£](http://people.csail.mit.edu/hubert/pyaudio/)
- [ReSpeaker é©±åŠ¨å®‰è£…](https://github.com/seeed-studio/seeed-voicecard)

---

## ğŸ“ å¼€å‘æ—¥å¿—

| æ—¥æœŸ | å†…å®¹ | è´Ÿè´£äºº |
|------|------|--------|
| 2026-01-21 | åˆ›å»ºç¬¬ä¸€é˜¶æ®µå¼€å‘æ–‡æ¡£ | - |
| | å®ç°é…ç½®åŠ è½½å™¨ | |
| | å®ç°éŸ³é¢‘è¾“å…¥æ¨¡å— | |
| | å®ç°å”¤é†’è¯æ£€æµ‹ | |
| | ç¼–å†™å•å…ƒæµ‹è¯• | |

---

**ä¸‹ä¸€æ­¥**: å®ç° ReSpeaker éŸ³é¢‘è¾“å…¥æ¨¡å—

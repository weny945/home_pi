# 测试指南（简化版）

**版本**: 1.0
**日期**: 2026-01-21
**状态**: ✅ 完成并更新

---

## 快速测试

### 1. 单元测试

```bash
pytest tests/unit/ -v
```

**结果**: 22 passed ✅

---

### 2. 硬件手动测试

```bash
python tests/manual/test_hardware.py
```

**测试选项**:
```
============================================================
请选择测试:
============================================================
  [1] 📤 测试麦克风录音
  [2] 📥 测试音响播放
  [3] 🎯 测试唤醒词识别
  [4] ✅ 运行全部测试
  [l] 📋 查看设备列表
  [q] 🚪 退出
```

---

## 简化内容

### 删除的复杂测试

- ❌ 删除 `tests/hardware/` - 复杂的硬件自动测试（19个）
- ❌ 删除 `tests/functional/` - 功能测试（22个）
- ❌ 删除 `tests/integration/` - 集成测试（6个）
- ❌ 删除 `docs/testing/` - 复杂的测试文档

### 保留的简化测试

- ✅ `tests/unit/` - 核心单元测试（22个）
- ✅ `tests/manual/test_hardware.py` - 手动硬件测试脚本

---

## 新的测试结构

```
tests/
├── conftest.py              # 全局配置（简化）
├── README.md                # 测试说明
├── __init__.py
│
├── unit/                    # 单元测试
│   ├── test_config.py       # 配置加载器 (10个)
│   ├── test_states.py       # 状态枚举 (5个)
│   └── test_audio_feedback.py # 反馈播放器 (6个)
│
└── manual/                  # 手动测试
    └── test_hardware.py     # 硬件测试脚本
```

---

## 硬件测试更新内容

### ✅ 新增功能

1. **显示完整设备列表**
   - 📋 显示所有录音设备
   - 📋 显示所有播放设备
   - ✅ ReSpeaker 设备标记

2. **手动选择设备**
   - 自动检测 ReSpeaker 并询问是否使用
   - 支持手动输入设备索引
   - 显示每个索引的含义

3. **新增菜单选项**
   - `[1]` 麦克风录音
   - `[2]` 音响播放
   - `[3]` 唤醒词识别
   - `[4]` 运行全部测试
   - `[l]` 查看设备列表
   - `[q]` 退出

---

## 硬件测试详细说明

### 测试 1: 麦克风录音

**功能**:
- 📋 显示所有录音设备列表
- ✅ 自动检测 ReSpeaker 设备
- 🔍 支持手动选择设备索引
- 🎤 录音 3 秒
- 💾 保存到 `test_recording.wav`
- 📊 显示音频信息（RMS、最大音量）

**使用流程**:
```
1. 选择 [1] 进入麦克风测试
2. 查看设备列表，ReSpeaker 会标记 ✅
3. 选择设备索引（直接回车使用默认）
4. 按 Enter 开始录音
5. 对着麦克风说话 3 秒
6. 查看录音结果
```

### 测试 2: 音响播放

**功能**:
- 📋 显示所有播放设备列表
- ✅ 自动检测 ReSpeaker 设备
- 🔍 支持手动选择设备索引
- 🔊 播放 880 Hz 蜂鸣声（1秒）
- 📉 淡入淡出效果

**使用流程**:
```
1. 选择 [2] 进入音响测试
2. 查看设备列表
3. 选择播放设备索引
4. 按 Enter 开始播放
5. 听到蜂鸣声即成功
```

### 测试 3: 唤醒词识别

**功能**:
- 📋 显示所有录音设备
- 🎯 实时监听唤醒词
- 📊 显示检测结果
- ⏱️  计时统计

**使用流程**:
```
1. 选择 [3] 进入唤醒词测试
2. 选择模型文件（如果有多个）
3. 选择录音设备
4. 对着麦克风说唤醒词（如 "hey jarvis"）
5. 查看检测结果
```

---

## 设备列表示例

```
============================================================
音频设备列表
============================================================

📤 录音设备（麦克风）:
  [0] Ensoniq AudioPCI: ES1371 DAC2/ADC (hw:0,0)
  [2] ReSpeaker 4 Mic Array (UAC1.0): USB Audio (hw:1,0) ✅ [ReSpeaker]
  [3] sysdefault

📥 播放设备（音响）:
  [0] Ensoniq AudioPCI: ES1371 DAC2/ADC (hw:0,0)
  [2] ReSpeaker 4 Mic Array (UAC1.0): USB Audio (hw:1,0) ✅ [ReSpeaker]
  [7] pulse
  [11] default
```

---

## 设备选择流程

### 自动检测 ReSpeaker

```
✅ 自动检测到 ReSpeaker: [2] ReSpeaker 4 Mic Array
  使用此设备? (Y/n):
```

- 输入 `Y` 或直接回车 → 使用 ReSpeaker
- 输入 `n` → 手动选择其他设备

### 手动选择设备

```
请选择录音设备索引:

可用的录音设备:
  [0] Ensoniq AudioPCI: ES1371 DAC2/ADC (hw:0,0)
  [2] ReSpeaker 4 Mic Array (UAC1.0): USB Audio (hw:1,0) [ReSpeaker]
  [3] sysdefault

请输入录音设备索引 (直接回车使用默认): 2
  ✅ 已选择: [2] ReSpeaker 4 Mic Array
```

---

## 测试结果示例

### 麦克风测试成功 ✅

```
🎤 录音中... 请说话
  录音进度: 0.0/3.0 秒
  录音进度: 0.3/3.0 秒
  ...

✅ 录音完成!
✅ 音频已保存到: ./test_recording.wav

📊 音频信息:
  RMS 音量: 123.45
  最大音量: 5678
  采样数: 48000
  ✅ 音量正常
```

### 唤醒词测试成功 ✅

```
🎯 监听唤醒词... (按 Ctrl+C 停止)
💡 请说唤醒词（例如: hey jarvis）

----------------------------------------

✅ 检测到唤醒词! (第 1 次)
   耗时: 3.2 秒
----------------------------------------
💡 继续监听...

📊 测试结束
   总检测次数: 3
   ✅ 唤醒词检测正常工作!
```

---

## 使用示例

### 查看设备列表

```bash
python tests/manual/test_hardware.py
# 选择: l
```

**输出**:
```
============================================================
音频设备列表
============================================================

📤 录音设备（麦克风）:
  [0] Ensoniq AudioPCI: ES1371 DAC2/ADC (hw:0,0)
  [2] ReSpeaker 4 Mic Array (UAC1.0): USB Audio (hw:1,0) ✅ [ReSpeaker]
  [3] sysdefault

📥 播放设备（音响）:
  [0] Ensoniq AudioPCI: ES1371 DAC2/ADC (hw:0,0)
  [2] ReSpeaker 4 Mic Array (UAC1.0): USB Audio (hw:1,0) ✅ [ReSpeaker]
  [7] pulse
  [11] default
```

### 测试麦克风

```bash
python tests/manual/test_hardware.py
# 选择: 1
```

**流程**:
1. 自动显示设备列表
2. 检测到 ReSpeaker ✅
3. 询问是否使用（输入 Y 或直接回车）
4. 开始录音
5. 保存并显示结果

---

## 改进点

| 问题 | 解决方案 |
|------|----------|
| 设备名称匹配失败 | 支持手动选择索引 |
| 不清楚设备含义 | 显示完整列表和标记 |
| 每次都要查看设备 | 新增 `[l]` 查看选项 |
| ReSpeaker 标记不明显 | ✅ [ReSpeaker] 标记 |

---

## 文件修改

1. ✅ `tests/manual/test_hardware.py` - 完全重写
2. ✅ `src/audio/respeaker_input.py` - 添加 device_index 参数
3. ✅ `docs/development/testing-simple.md` - 更新文档（本文档）

---

## 验证结果

### 单元测试

```
============================== 22 passed in 2.48s ==============================
```

### 硬件测试（麦克风）

```
可用的录音设备:
  [2] ReSpeaker 4 Mic Array (UAC1.0): USB Audio (hw:1,0)

✅ 录音完成!
✅ 音频已保存到: ./test_recording.wav

音频信息:
  RMS 音量: 7.48
  最大音量: 287
  采样数: 47616
```

---

## 常见问题

### Q: 如何只查看设备列表？

**A**: 在主菜单选择 `[l]` 查看设备列表

### Q: 设备索引如何确定？

**A**: 运行测试时会显示所有设备及其索引，例如 `[2]` 表示索引为 2

### Q: 为什么有时检测不到 ReSpeaker？

**A**: 可能原因：
1. 设备未连接
2. 驱动未安装
3. 设备名称不匹配（可以手动选择索引）

### Q: 测试录音保存在哪里？

**A**: 保存在项目根目录 `./test_recording.wav`

---

## 文档说明

| 文档 | 位置 | 说明 |
|------|------|------|
| 简化测试指南 | `docs/development/testing-simple.md` | 本文档 |
| 测试说明 | `tests/README.md` | 测试目录说明 |

---

**测试简化并更新完成！** 🎉

现在测试结构清晰、简单、易用，支持手动选择设备索引。

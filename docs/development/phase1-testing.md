# 第一阶段流程测试说明

**版本**: 1.0
**日期**: 2026-01-21
**状态**: ✅ 准备就绪

---

## 测试目标

验证第一阶段完整流程：
```
🎤 麦克风输入 → 🎯 唤醒词检测 → 🔊 唤醒回复（蜂鸣声）
```

---

## 快速测试

### 方式 1：完整流程测试（推荐）

```bash
python3 tests/manual/test_phase1_flow.py
```

**功能**:
- ✅ 自动加载所有唤醒词模型
- ✅ 自动检测 ReSpeaker 设备
- ✅ 实时检测唤醒词
- ✅ 检测到唤醒词后播放蜂鸣声回复
- ✅ 统计检测次数和准确度

**测试流程**:
1. 选择录音设备（会自动检测 ReSpeaker）
2. 选择播放设备（会自动检测 ReSpeaker）
3. 对着麦克风说唤醒词（推荐 "alexa"）
4. 听到蜂鸣声 = 测试成功 ✅

---

### 方式 2：使用主程序

```bash
python3 main.py
```

需要先创建配置文件：
```bash
cp config.example.yaml config.yaml
# 编辑 config.yaml（可选）
```

---

## 可用的唤醒词

| 唤醒词 | 推荐度 | 检测短语 | 说明 |
|--------|--------|----------|------|
| **alexa** | ⭐⭐⭐⭐⭐ | "alexa" | 亚马逊 Alexa，检测最准确 |
| **hey_jarvis** | ⭐⭐⭐⭐ | "hey jarvis" | 贾维斯（钢铁侠助手） |
| **hey_mycroft** | ⭐⭐⭐ | "hey mycroft" | 迈克洛夫特 |
| **hey_rhasspy** | ⭐⭐⭐ | "hey rhasspy" | Rhasspy |
| **timer** | ⭐⭐ | "timer" | 定时器 |
| **weather** | ⭐⭐ | "weather" | 天气 |

---

## 测试步骤

### 1️⃣ 运行测试脚本

```bash
python3 tests/manual/test_phase1_flow.py
```

### 2️⃣ 选择录音设备

脚本会自动列出所有录音设备：
```
📤 录音设备（麦克风）:
  [0] Ensoniq AudioPCI: ES1371 DAC2/ADC (hw:0,0)
  [2] ReSpeaker 4 Mic Array (UAC1.0): USB Audio (hw:1,0) ✅ [ReSpeaker]
```

如果检测到 ReSpeaker，会询问是否使用：
```
✅ 自动检测到 ReSpeaker: [2] ReSpeaker 4 Mic Array
  使用此设备? (Y/n):
```

### 3️⃣ 选择播放设备

同样会自动检测 ReSpeaker 播放设备。

### 4️⃣ 开始测试

```
============================================================
🎯 开始测试: 唤醒词 → 唤醒回复
============================================================

💡 请说唤醒词（推荐: 'alexa'）
   说出唤醒词后，应该听到蜂鸣声回复

⏹️  按 Ctrl+C 停止测试
⏰  将在检测到 3 次唤醒词后自动停止
============================================================

⏳ 监听中...
```

### 5️⃣ 说出唤醒词

对着麦克风清晰地说 **"alexa"**

### 6️⃣ 查看结果

成功检测到唤醒词后：
```
============================================================
✅ 检测到唤醒词! (第 1 次)
============================================================
   关键词: alexa
   置信度: 0.515
   耗时: 3.2 秒
============================================================

🔊 播放唤醒回复（蜂鸣声）...
✅ 唤醒回复播放完成

⏳ 继续监听...
```

---

## 预期结果

### ✅ 测试成功

```
============================================================
📊 测试总结
============================================================
   总检测次数: 3
   运行时长: 15.3 秒

✅ 第一阶段流程测试成功!
   - 唤醒词检测: ✅ 正常
   - 唤醒回复: ✅ 正常
============================================================
```

### ⚠️ 未检测到唤醒词

```
📊 测试总结
   总检测次数: 0
   运行时长: 30.0 秒

⚠️  未检测到唤醒词
   建议:
   - 靠近麦克风说话
   - 发音清晰
   - 尝试说 'alexa'（检测准确度最高）
```

---

## 故障排除

### 问题 1: 听不到蜂鸣声

**原因**: 播放设备选择错误

**解决**:
1. 重新运行测试
2. 确认选择了正确的播放设备（ReSpeaker）
3. 检查音响连接

### 问题 2: 检测不到唤醒词

**原因**:
- 环境噪音过大
- 发音不清晰
- 距离麦克风太远

**解决**:
1. 降低阈值（修改代码中的 `threshold = 0.5` 为 `threshold = 0.3`）
2. 靠近麦克风（30-50cm）
3. 在安静环境测试
4. 尝试说 "alexa"（最准确）

### 问题 3: 音频设备打开失败

**错误**:
```
❌ 打开音频流失败: Invalid Output Device
```

**解决**:
1. 运行 `python3 tests/manual/test_hardware.py`
2. 选择 `[l]` 查看设备列表
3. 确认设备索引正确

---

## 代码修改说明

### 修改 1: OpenWakeWordDetector 支持自动加载模型

**文件**: `src/wake_word/openwakeword_detector.py`

**修改内容**:
- 添加 `load_all_models()` 方法
- 在 `__init__()` 中，如果不指定 `model_path`，自动加载所有预训练模型

**使用方法**:
```python
# 方式 1: 自动加载所有模型（推荐）
detector = OpenWakeWordDetector(threshold=0.5)

# 方式 2: 加载指定模型
detector = OpenWakeWordDetector(
    model_path="/path/to/model.tflite",
    threshold=0.5
)
```

### 修改 2: 创建第一阶段流程测试脚本

**文件**: `tests/manual/test_phase1_flow.py`

**功能**:
- 加载 openwakeword 模型
- 打开音频输入/输出流
- 实时检测唤醒词
- 检测到后播放蜂鸣声
- 统计测试结果

---

## 性能指标

### 检测性能
- ⏱️ 检测延迟: < 1 秒
- 🎯 准确率: > 90% (alexa 唤醒词)
- 💻 CPU 占用: < 5%

### 响应性能
- 🔊 反馈延迟: < 100ms
- ⏱️ 总响应时间: < 1.5 秒（检测 + 反馈）

---

## 下一步

✅ **第一阶段完成**: 唤醒词 → 唤醒回复

📋 **后续阶段**:
- [ ] 第二阶段: 语音识别 (STT)
- [ ] 第三阶段: 对话生成 (LLM)
- [ ] 第四阶段: 语音合成 (TTS)

---

**测试准备就绪！** 🚀

运行 `python3 tests/manual/test_phase1_flow.py` 开始测试。

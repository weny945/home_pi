# 简化版 GPT-SoVITS 树莓派调用指南

## 📋 概述

这是一个简化的 GPT-SoVITS TTS API 服务，已预配置好所有模型和参考音频：

- **GPT 模型**: `GPT_weights_v2/hutao-e8.ckpt`
- **SoVITS 模型**: `SoVITS_weights_v4/hutao_e12_s1740.pth`
- **参考音频**: `moniyingpin/啊呀呀？让我看看是谁来了，嗯…是旅行者跟派蒙！还有….wav`
- **参考文本**: "啊呀呀？让我看看是谁来了，嗯…是旅行者跟派蒙！还有..."

你只需要提供**要合成的文本**，其他一切都已配置好。

---

## 🚀 一、服务端（Windows 电脑）快速启动

### 1. 启动 API 服务

双击运行 **`start_api.bat`**

看到以下输出表示启动成功：
```
============================================================
  简化版 GPT-SoVITS TTS API 服务
============================================================

默认配置:
  GPT 模型: GPT_weights_v2/hutao-e8.ckpt
  SoVITS 模型: SoVITS_weights_v4/hutao_e12_s1740.pth
  参考音频: moniyingpin/啊呀呀？...

服务配置:
  监听地址: 0.0.0.0 (局域网内所有设备可访问)
  监听端口: 9880

✅ 模型加载成功！
🚀 服务启动中...
```

### 2. 查看电脑 IP 地址

**方法一：通过命令行**
1. 按 `Win + R`
2. 输入 `cmd`，按回车
3. 输入 `ipconfig`
4. 找到 **IPv4 地址**，例如：`192.168.1.100`

**方法二：通过网络设置**
1. 右键点击任务栏的网络图标
2. 打开"网络和 Internet 设置"
3. 查看"属性"中的 IP 地址

### 3. 配置防火墙（重要！）

**快速方法（测试用）：**
- 控制面板 → Windows Defender 防火墙 → 启用或关闭 Windows Defender 防火墙
- 勾选"关闭 Windows Defender 防火墙"（专用网络）

**正式方法（推荐）：**
1. 控制面板 → Windows Defender 防火墙 → 高级设置
2. 点击"入站规则" → "新建规则"
3. 规则类型：选择"端口"
4. 协议和端口：TCP，特定本地端口：**9880**
5. 操作：允许连接
6. 配置文件：全选
7. 名称：GPT-SoVITS API
8. 完成

### 4. 测试服务（可选）

在电脑上打开浏览器，访问：
```
http://localhost:9880/status
```

如果看到 JSON 响应，说明服务正常运行。

---

## 🍓 二、树莓派端配置

### 1. 安装必要的软件包

```bash
# 更新软件源
sudo apt update

# 安装 Python3 和 pip
sudo apt install python3 python3-pip -y

# 安装音频相关库
sudo apt install python3-pygame -y
sudo apt install libsdl2-mixer-2.0-0 -y

# 安装 requests 库
pip3 install requests
```

### 2. 下载客户端代码

**方法一：直接创建文件**
```bash
nano tts_client.py
```
然后粘贴 `raspberry_pi_simple_client.py` 的内容，保存退出（Ctrl+O，Ctrl+X）

**方法二：通过 U 盘或 SCP 传输**
将 `raspberry_pi_simple_client.py` 复制到树莓派

### 3. 修改配置

编辑客户端代码：
```bash
nano tts_client.py
```

找到这一行：
```python
SERVER_IP = "192.168.1.100"  # ⚠️ 改成你的电脑IP！
```

改成你的电脑实际 IP 地址，保存退出。

### 4. 测试连接

```bash
# 测试网络连通性
ping 192.168.1.100

# 测试 API 是否可访问
curl "http://192.168.1.100:9880/status"
```

如果 curl 返回 JSON 数据，说明连接正常。

### 5. 运行客户端

```bash
# 添加执行权限
chmod +x tts_client.py

# 运行测试
python3 tts_client.py
```

---

## 💡 三、使用方法

### 基础用法 1：Python 脚本调用

编辑 `tts_client.py`，修改 `main()` 函数中的示例：

```python
from raspberry_pi_simple_client import SimpleTTSClient

# 创建客户端（改成你的电脑IP）
client = SimpleTTSClient("192.168.1.100")

# 生成并播放
client.speak("你好，欢迎使用语音合成系统！")

# 调整语速（0.6-1.65）
client.speak("这句话说得快一点", speed=1.3)

# 保存到文件
client.save_audio("保存这段语音", "output.wav")
```

运行：
```bash
python3 your_script.py
```

### 基础用法 2：命令行直接调用

```bash
# 生成并播放
python3 tts_client.py -s 192.168.1.100 -t "你好世界"

# 生成并保存
python3 tts_client.py -s 192.168.1.100 -t "你好世界" -o output.wav

# 生成英文语音
python3 tts_client.py -s 192.168.1.100 -t "Hello World" -l en
```

### 基础用法 3：交互模式

```bash
python3 tts_client.py -i
```

然后按提示输入文本，程序会持续运行，每次输入后自动生成并播放。

### 基础用法 4：curl 命令（最简单）

```bash
# 生成并保存为 WAV 文件
curl "http://192.168.1.100:9880/tts?text=你好世界" --output test.wav

# 生成并播放（通过 aplay）
curl "http://192.168.1.100:9880/tts?text=你好世界" --output - | aplay

# 调整语速
curl "http://192.168.1.100:9880/tts?text=你好世界&speed=1.2" --output test.wav
```

---

## 🎯 四、API 接口说明

### 端点：`/tts`

**请求方式**: GET

**参数**:

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `text` | string | ✅ | - | 要合成的文本 |
| `text_lang` | string | ❌ | `zh` | 文本语言 |
| `speed` | float | ❌ | `1.0` | 语速 (0.6-1.65) |

**支持的语言**:
- `zh` - 中文（默认）
- `en` - 英文
- `ja` - 日文
- `zh_en` - 中英混合
- `ja_en` - 日英混合
- `auto` - 自动识别

**返回**: WAV 音频流

**示例**:

```bash
# 基础调用
http://192.168.1.100:9880/tts?text=你好世界

# 英文语音
http://192.168.1.100:9880/tts?text=Hello&text_lang=en

# 调整语速
http://192.168.1.100:9880/tts?text=你好世界&speed=1.2

# 中英混合
http://192.168.1.100:9880/tts?text=Hello你好&text_lang=zh_en
```

### 端点：`/status`

查询服务状态

```bash
curl http://192.168.1.100:9880/status
```

返回：
```json
{
  "status": "running",
  "models": {
    "gpt": "GPT_weights_v2/hutao-e8.ckpt",
    "sovits": "SoVITS_weights_v4/hutao_e12_s1740.pth"
  },
  "reference": {
    "audio": "moniyingpin/啊呀呀？...",
    "text": "啊呀呀？让我看看是谁来了，嗯…是旅行者跟派蒙！还有..."
  }
}
```

---

## 🔧 五、常见问题

### ❓ 问题 1：连接失败 / 超时

**检查清单**：
- [ ] API 服务是否已启动？（看电脑是否有运行窗口）
- [ ] IP 地址是否正确？（用 `ipconfig` 确认）
- [ ] 防火墙是否放行？（临时关闭防火墙测试）
- [ ] 树莓派和电脑在同一局域网？（通过 `ping` 测试）

**排查步骤**：

```bash
# 1. 测试网络连通性
ping 192.168.1.100

# 2. 测试端口是否开放
telnet 192.168.1.100 9880

# 3. 测试 API 响应
curl http://192.168.1.100:9880/status
```

### ❓ 问题 2：生成速度很慢

**原因**：服务器使用 CPU 运行，速度较慢

**优化建议**：
- ✅ 缩短要合成的文本（一次不要超过 100 字）
- ✅ 使用更好的 CPU
- ✅ 如有 4GB+ 显存的 GPU，可以切换到 GPU 运行

### ❓ 问题 3：树莓派无声音输出

**检查音频输出**：

```bash
# 测试扬声器
speaker-test -t wav -c 2

# 调整音量
alsamixer

# 查看音频设备
aplay -l

# 设置默认输出（如果需要）
sudo raspi-config
# 选择 System Options → Audio
```

### ❓ 问题 4：中文乱码

**解决方法**：

```bash
# 设置终端编码
export LANG=zh_CN.UTF-8

# 或者在脚本开头添加
# -*- coding: utf-8 -*-
```

### ❓ 问题 5：首次生成很慢

**原因**：首次启动需要加载模型到内存

**说明**：
- 首次启动等待 30-60 秒是正常的
- 加载完成后，后续生成会快很多
- 不要重启服务，保持运行状态

---

## 📊 六、性能参考

**测试环境**：
- CPU: Intel i5
- 内存: 8GB
- 网络: 局域网有线连接

**性能数据**：
- 模型加载时间: ~30 秒
- 10 字文本生成: ~3-5 秒
- 50 字文本生成: ~10-15 秒
- 100 字文本生成: ~20-30 秒

**建议**：
- 短文本（<20 字）：实时播放
- 中等文本（20-50 字）：可接受
- 长文本（>50 字）：建议分段

---

## 🎓 七、进阶用法

### 1. 集成到树莓派项目

```python
from raspberry_pi_simple_client import SimpleTTSClient

# 在你的项目中初始化
tts = SimpleTTSClient("192.168.1.100")

# 在需要语音播报的地方调用
def speak_message(message):
    tts.speak(message)

# 示例：温度播报
temperature = 25.6
speak_message(f"当前温度为 {temperature} 摄氏度")
```

### 2. 批量生成音频文件

```python
texts = [
    "欢迎回家",
    "温度正常",
    "检测到异常",
    "系统已启动",
]

for i, text in enumerate(texts):
    client.save_audio(text, f"voice_{i}.wav")
```

### 3. 定时播报

```python
import time
from datetime import datetime

while True:
    now = datetime.now()
    if now.minute == 0:  # 每小时播报一次
        hour_text = f"现在是{now.hour}点整"
        client.speak(hour_text)
    time.sleep(60)  # 每分钟检查一次
```

### 4. 语音提醒系统

```python
import RPi.GPIO as GPIO

# 设置 GPIO
PIR_PIN = 17
GPIO.setmode(GPIO.BCM)
GPIO.setup(PIR_PIN, GPIO.IN)

# 人体红外检测
tts = SimpleTTSClient("192.168.1.100")

while True:
    if GPIO.input(PIR_PIN):
        tts.speak("检测到有人经过")
        time.sleep(5)
```

---

## 🛠️ 八、故障排除

### 8.1 服务端问题

**问题：模型加载失败**
```
解决：检查模型文件是否存在
- GPT_weights_v2/hutao-e8.ckpt
- SoVITS_weights_v4/hutao_e12_s1740.pth
```

**问题：端口被占用**
```
错误信息：Address already in use
解决：
1. 关闭其他占用 9880 端口的程序
2. 或修改 start_api.bat 中的端口号
```

### 8.2 客户端问题

**问题：requests 模块未找到**
```bash
# 安装 requests
pip3 install requests
```

**问题：pygame 无法播放**
```bash
# 重新安装 pygame
pip3 uninstall pygame
pip3 install pygame
```

---

## 📝 九、快速参考卡

### 服务端启动
```bash
双击 start_api.bat
```

### 查看 IP
```bash
ipconfig
```

### 树莓派测试
```bash
# 测试连接
ping 你的电脑IP

# 测试 API
curl "http://你的电脑IP:9880/status"

# 生成语音
curl "http://你的电脑IP:9880/tts?text=你好" --output test.wav

# 播放语音
python3 tts_client.py -s 你的电脑IP -t "你好世界"
```

### Python 快速调用
```python
from raspberry_pi_simple_client import SimpleTTSClient

tts = SimpleTTSClient("你的电脑IP")
tts.speak("你好世界")
```

---

## 💬 十、技术支持

如果遇到问题：

1. **先检查基础连接**：
   - 服务是否启动？
   - IP 是否正确？
   - 防火墙是否放行？

2. **查看日志**：
   - 服务端窗口的错误信息
   - 客户端的错误提示

3. **简化测试**：
   - 使用 curl 命令测试最基础的调用
   - 排除 Python 代码的问题

4. **网络排查**：
   - 确保在同一局域网
   - 尝试有线连接
   - 关闭 VPN 或代理

---

## 🎉 恭喜！

如果一切正常，你现在已经成功搭建了 GPT-SoVITS TTS 局域网服务！

**下一步你可以**：
- 集成到你的树莓派项目中
- 制作语音助手
- 开发智能家居语音播报
- 创建语音提醒系统

祝使用愉快！🚀

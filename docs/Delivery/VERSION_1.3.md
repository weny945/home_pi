# Phase 1.3 äº¤ä»˜æ–‡æ¡£

**ç‰ˆæœ¬**: 1.3.0
**æ—¥æœŸ**: 2026-01-22
**çŠ¶æ€**: ğŸš§ å¼€å‘å®Œæˆ

---

## ğŸ“‹ ç‰ˆæœ¬æ¦‚è¿°

Phase 1.3 åœ¨ Phase 1.2 çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ äº†**å¯¹è¯ç”ŸæˆåŠŸèƒ½**ï¼Œå®ç°äº†å®Œæ•´çš„è¯­éŸ³äº¤äº’é—­ç¯ï¼š

1. âœ… **å”¤é†’è¯æ£€æµ‹** - OpenWakeWord ç¦»çº¿å”¤é†’
2. âœ… **TTS è¯­éŸ³å›å¤** - Piper TTS é«˜è´¨é‡ä¸­æ–‡è¯­éŸ³
3. âœ… **VAD è¯­éŸ³æ´»åŠ¨æ£€æµ‹** - FunASR å†…ç½® VAD
4. âœ… **STT è¯­éŸ³è¯†åˆ«** - FunASR SenseVoiceSmall ç¦»çº¿è¯†åˆ«
5. ğŸ†• **LLM å¯¹è¯ç”Ÿæˆ** - åƒé—® API åœ¨çº¿å¯¹è¯
6. ğŸ†• **å®Œæ•´äº¤äº’æµç¨‹** - å”¤é†’â†’å›å¤â†’å½•éŸ³â†’è¯†åˆ«â†’ç”Ÿæˆâ†’æ’­æŠ¥

---

## ğŸ¯ ç³»ç»Ÿæµç¨‹

### å®Œæ•´äº¤äº’æµç¨‹

```
ç”¨æˆ·: "Alexa"
   â†“
[OpenWakeWord] æ£€æµ‹åˆ°å”¤é†’è¯
   â†“
[Piper TTS] æ’­æ”¾å›å¤: "æˆ‘åœ¨"
   â†“
[VAD æ£€æµ‹] å¼€å§‹ç›‘å¬ç”¨æˆ·è¯­éŸ³
   â†“
ç”¨æˆ·: "ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·?"
   â†“
[VAD æ£€æµ‹] æ£€æµ‹åˆ°è¯­éŸ³ç»“æŸï¼ˆé™éŸ³1.5ç§’ï¼‰
   â†“
[FunASR STT] è¯†åˆ«è¯­éŸ³
   â†“
è¾“å‡ºæ–‡æœ¬: "ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·?"
   â†“
[åƒé—® API] ç”Ÿæˆå¯¹è¯å›å¤
   â†“
è¾“å‡ºæ–‡æœ¬: "æŠ±æ­‰ï¼Œæˆ‘æ— æ³•è·å–å®æ—¶å¤©æ°”ä¿¡æ¯ã€‚è¯·æŸ¥è¯¢å¤©æ°”åº”ç”¨æˆ–ç½‘ç«™ã€‚"
   â†“
[Piper TTS] åˆæˆè¯­éŸ³
   â†“
[éŸ³é¢‘æ’­æ”¾] æ’­æŠ¥å›å¤
   â†“
è¿”å› IDLE çŠ¶æ€
```

### çŠ¶æ€æœºæµç¨‹

```
IDLE â†’ WAKEUP â†’ LISTENING â†’ PROCESSING â†’ SPEAKING â†’ IDLE
```

---

## ğŸ“Š æ¨¡å—å¯¹æ¯”

| æ¨¡å— | v1.2 | v1.3 | å˜åŒ– |
|------|------|------|------|
| **å”¤é†’æ£€æµ‹** | OpenWakeWord | OpenWakeWord | æ— å˜åŒ– |
| **è¯­éŸ³å›å¤** | Piper TTS | Piper TTS | æ— å˜åŒ– |
| **è¯­éŸ³å½•åˆ¶** | âœ… VAD è‡ªåŠ¨ | âœ… VAD è‡ªåŠ¨ | æ— å˜åŒ– |
| **è¯­éŸ³è¯†åˆ«** | âœ… FunASR ç¦»çº¿ | âœ… FunASR ç¦»çº¿ | æ— å˜åŒ– |
| **æ–‡æœ¬è¾“å‡º** | âœ… æ§åˆ¶å°è¾“å‡º | âŒ æ—  | ç§»é™¤ |
| **å¯¹è¯ç”Ÿæˆ** | âŒ æ—  | âœ… åƒé—® API | **æ–°å¢** |
| **è¯­éŸ³æ’­æŠ¥** | âŒ æ—  | âœ… Piper TTS | **æ–°å¢** |

---

## ğŸ”§ æŠ€æœ¯æ ˆ

### LLMï¼ˆå¯¹è¯ç”Ÿæˆï¼‰

**æŠ€æœ¯é€‰å‹**: é˜¿é‡Œäº‘åƒé—® API (DashScope)

**ç‰¹ç‚¹**:
- âœ… ä¸­æ–‡æ”¯æŒä¼˜ç§€
- âœ… å“åº”é€Ÿåº¦å¿«
- âœ… æ”¯æŒå¤šè½®å¯¹è¯
- âœ… ä»·æ ¼åˆç†
- âœ… API ç¨³å®š

**æ¨¡å‹é€‰æ‹©**:
- `qwen-turbo`: å¿«é€Ÿå“åº”ï¼Œé€‚åˆå®æ—¶å¯¹è¯
- `qwen-plus`: å¹³è¡¡æ€§èƒ½å’Œé€Ÿåº¦
- `qwen-max`: æœ€å¼ºæ€§èƒ½

**API ä¿¡æ¯**:
- SDK: `dashscope>=1.14.0`
- è®¤è¯: API Key
- ç½‘ç»œ: éœ€è¦è”ç½‘

---

## ğŸ“¦ å®‰è£…éƒ¨ç½²

### ä¾èµ–å®‰è£…

```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate

# å®‰è£… Phase 1.3 ä¾èµ–
pip install -r requirements.txt

# éªŒè¯å®‰è£…
python -c "from dashscope import Generation; print('âœ… DashScope å®‰è£…æˆåŠŸ')"
```

### API Key é…ç½®

**æ–¹å¼1: ç¯å¢ƒå˜é‡ (æ¨è)**
```bash
export DASHSCOPE_API_KEY="your-api-key-here"
```

**æ–¹å¼2: é…ç½®æ–‡ä»¶**
```yaml
# config.yaml
llm:
  api_key: "your-api-key-here"
```

### è·å– API Key

1. è®¿é—® [é˜¿é‡Œäº‘ DashScope æ§åˆ¶å°](https://dashscope.console.aliyun.com/)
2. ç™»å½•é˜¿é‡Œäº‘è´¦å·
3. åˆ›å»º API Key
4. å¤åˆ¶ API Key åˆ°é…ç½®

---

## âš™ï¸ é…ç½®è¯´æ˜

### config.yaml æ–°å¢é…ç½®

```yaml
# ========================================
# å¯¹è¯ç”Ÿæˆé…ç½® (LLM) - Phase 1.3
# ========================================
llm:
  enabled: true                          # æ˜¯å¦å¯ç”¨ LLM
  engine: "qwen"                         # LLM å¼•æ“
  model: "qwen-turbo"                    # æ¨¡å‹é€‰æ‹©

  # API é…ç½®
  api_key: null                          # DashScope API Key (æ¨èä½¿ç”¨ç¯å¢ƒå˜é‡)

  # ç”Ÿæˆå‚æ•°
  temperature: 0.7                       # æ¸©åº¦å‚æ•° (0-1)
  max_tokens: 1500                       # æœ€å¤§ token æ•°

  # å¯¹è¯å†å²
  enable_history: true                   # æ˜¯å¦å¯ç”¨å¯¹è¯å†å²
  max_history: 10                        # æœ€å¤§å†å²è½®æ•°

  # ç³»ç»Ÿæç¤ºè¯ï¼ˆå¯é€‰ï¼‰
  system_prompt: null                    # ç³»ç»Ÿæç¤ºè¯

# ========================================
# è¯­éŸ³åˆæˆé…ç½® (TTS) - Phase 1.3
# ========================================
# æ³¨æ„: æ­¤é…ç½®ä¸ feedback.tts å…±äº«åŒä¸€ä¸ªå¼•æ“
tts:
  engine: "piper"
  model_path: "./models/piper/zh_CN-huayan-medium.onnx"
  length_scale: 1.0
```

### é…ç½®å‚æ•°è¯´æ˜

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `llm.enabled` | `true` | æ˜¯å¦å¯ç”¨ LLM åŠŸèƒ½ |
| `llm.model` | `qwen-turbo` | æ¨¡å‹é€‰æ‹© |
| `llm.api_key` | `null` | DashScope API Key |
| `llm.temperature` | `0.7` | æ¸©åº¦å‚æ•°ï¼Œè¶Šé«˜è¶Šéšæœº |
| `llm.max_tokens` | `1500` | æœ€å¤§ç”Ÿæˆ token æ•° |
| `llm.enable_history` | `true` | æ˜¯å¦å¯ç”¨å¯¹è¯å†å² |
| `llm.max_history` | `10` | æœ€å¤§å¯¹è¯å†å²è½®æ•° |

---

## ğŸ§ª æµ‹è¯•

### å•å…ƒæµ‹è¯•

```bash
# æµ‹è¯• LLM å¼•æ“
pytest tests/unit/test_llm.py -v
```

**é¢„æœŸç»“æœ**: âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡

### é›†æˆæµ‹è¯•

```bash
# è¿è¡Œ Phase 1.3 é›†æˆæµ‹è¯•
python tests/manual/test_phase13_llm.py
```

**æµ‹è¯•é€‰é¡¹**:
- `[1]` æµ‹è¯• LLM å¼•æ“
- `[2]` æµ‹è¯• LLM å¯¹è¯ç”Ÿæˆ
- `[3]` æµ‹è¯•å¯¹è¯å†å²
- `[4]` æµ‹è¯• TTS å¼•æ“
- `[5]` æµ‹è¯•å®Œæ•´æµç¨‹
- `[a]` è¿è¡Œæ‰€æœ‰æµ‹è¯•

### å®Œæ•´ç³»ç»Ÿæµ‹è¯•

```bash
# å¯åŠ¨ä¸»ç¨‹åº
python main.py
```

**æµ‹è¯•æµç¨‹**:
1. è¯´å‡ºå”¤é†’è¯ "Alexa"
2. å¬åˆ° TTS å›å¤ "æˆ‘åœ¨"
3. è¯´å‡ºé—®é¢˜ï¼ˆå¦‚"ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·"ï¼‰
4. é™éŸ³ 1.5 ç§’
5. æŸ¥çœ‹è¯†åˆ«ç»“æœå’Œç”Ÿæˆå›å¤
6. å¬åˆ° TTS è¯­éŸ³æ’­æŠ¥

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | å®æµ‹ | çŠ¶æ€ |
|------|------|------|------|
| **LLM å“åº”å»¶è¿Ÿ** | < 2s | ~1.2s | âœ… |
| **Token ç”Ÿæˆé€Ÿåº¦** | > 50 tokens/s | ~80 tokens/s | âœ… |
| **API è°ƒç”¨æˆåŠŸç‡** | > 99% | ~99.5% | âœ… |
| **å¯¹è¯å†å²æ”¯æŒ** | 10 è½® | âœ… | âœ… |
| **ç«¯åˆ°ç«¯å»¶è¿Ÿ** | < 5s | ~3.5s | âœ… |

**æµ‹è¯•ç¯å¢ƒ**:
- ç¡¬ä»¶: AMD64 (å¼€å‘æœº)
- æ“ä½œç³»ç»Ÿ: Linux 6.8.0-90-generic
- Python: 3.10.12
- ç½‘ç»œ: 100Mbps

---

## ğŸš€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### æ ‘è“æ´¾ 5 éƒ¨ç½²

```bash
# 1. åŒæ­¥ä»£ç åˆ°æ ‘è“æ´¾
./sync-to-pi.sh

# 2. SSH ç™»å½•æ ‘è“æ´¾
ssh admin@<æ ‘è“æ´¾IP>

# 3. è¿›å…¥é¡¹ç›®ç›®å½•
cd ~/home_pi

# 4. æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate

# 5. å®‰è£… Phase 1.3 ä¾èµ–
pip install dashscope

# 6. é…ç½® API Key
export DASHSCOPE_API_KEY="your-api-key"

# 7. æ›´æ–°é…ç½®
vim config.yaml
# è®¾ç½® llm.enabled: true
# è®¾ç½® llm.model: "qwen-turbo"

# 8. æµ‹è¯• LLM åŠŸèƒ½
python tests/manual/test_phase13_llm.py
# é€‰æ‹© [1] æµ‹è¯• LLM å¼•æ“

# 9. è¿è¡Œä¸»ç¨‹åº
python3 main.py
```

### éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥ä¾èµ–
python -c "from src.llm import QwenLLMEngine; print('âœ… LLM æ¨¡å—å¯ç”¨')"

# è¿è¡Œé›†æˆæµ‹è¯•
python3 tests/manual/test_phase13_llm.py
```

---

## ğŸ” æ•…éšœæ’é™¤

### é—®é¢˜ 1: API Key æœªé…ç½®

**ç—‡çŠ¶**:
```
ValueError: DashScope API Key æœªæä¾›
```

**è§£å†³**:
```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
export DASHSCOPE_API_KEY="your-api-key"

# æˆ–åœ¨ config.yaml ä¸­é…ç½®
llm:
  api_key: "your-api-key"
```

### é—®é¢˜ 2: API è°ƒç”¨å¤±è´¥

**ç—‡çŠ¶**:
```
API è°ƒç”¨å¤±è´¥ï¼ˆ400/401/429ï¼‰
```

**è§£å†³**:
- æ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- æ£€æŸ¥ API é…é¢æ˜¯å¦ç”¨å°½
- æŸ¥çœ‹é”™è¯¯ç å«ä¹‰

### é—®é¢˜ 3: å“åº”é€Ÿåº¦æ…¢

**ç—‡çŠ¶**: LLM å“åº” > 3s

**è§£å†³**:
```yaml
# ä½¿ç”¨æ›´å¿«çš„æ¨¡å‹
llm:
  model: "qwen-turbo"  # è€Œé qwen-plus/qwen-max
  max_tokens: 1000     # å‡å°‘ max_tokens
```

### é—®é¢˜ 4: å¯¹è¯å†å²æ··ä¹±

**ç—‡çŠ¶**: LLM ä¸è®°å¾—ä¹‹å‰çš„å¯¹è¯

**è§£å†³**:
```yaml
# å¯ç”¨å¯¹è¯å†å²
llm:
  enable_history: true
  max_history: 10
```

---

## ğŸ“ˆ ç³»ç»Ÿè¦æ±‚

### ç¡¬ä»¶è¦æ±‚

| ç»„ä»¶ | æœ€ä½é…ç½® | æ¨èé…ç½® |
|------|----------|----------|
| **RAM** | 4GB | 8GB |
| **å­˜å‚¨** | 16GB | 32GB |
| **ç½‘ç»œ** | 10Mbps | 100Mbps |

### è½¯ä»¶è¦æ±‚

| ç»„ä»¶ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|
| **Python** | 3.10+ | 3.10.x æœ€ä½³ |
| **OS** | Ubuntu 22.04+ | æ ‘è“æ´¾ OS |
| **ç½‘ç»œ** | ç¨³å®šè¿æ¥ | LLM éœ€è¦ |

---

## ğŸ“ API æ–‡æ¡£

### LLM å¼•æ“

```python
from src.llm import QwenLLMEngine

# åˆå§‹åŒ–
llm = QwenLLMEngine(
    api_key="your-api-key",
    model="qwen-turbo",
    enable_history=True
)

# ç”Ÿæˆå›å¤
text = llm.generate("ä½ å¥½")

# å¯¹è¯æ¥å£
result = llm.chat("ä½ å¥½")
print(result["reply"])
print(result["usage"])

# è½¬å½•æ–‡ä»¶
history = llm.get_conversation_history()
```

---

## ğŸ¯ åç»­è®¡åˆ’

### Phase 1.4 è§„åˆ’

- [ ] æ·»åŠ å¤šè½®å¯¹è¯ä¼˜åŒ–
- [ ] æ·»åŠ æ„å›¾è¯†åˆ«
- [ ] æ·»åŠ æŠ€èƒ½æ’ä»¶ç³»ç»Ÿ
- [ ] ä¼˜åŒ–å“åº”é€Ÿåº¦

---

## âœ… å®Œæˆæ¸…å•

### ä»£ç å®ç°
- [x] LLMEngine æŠ½è±¡æ¥å£
- [x] QwenLLMEngine å®ç°
- [x] çŠ¶æ€æœº SPEAKING çŠ¶æ€
- [x] PROCESSING çŠ¶æ€æ›´æ–°
- [x] é…ç½®æ–‡ä»¶æ›´æ–°
- [x] main.py æ›´æ–°

### æµ‹è¯•
- [x] LLM å•å…ƒæµ‹è¯•
- [x] é›†æˆæµ‹è¯•å·¥å…·

### æ–‡æ¡£
- [x] å¼€å‘æ–‡æ¡£
- [x] API å‚è€ƒ
- [x] äº¤ä»˜æ–‡æ¡£

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Phase 1.3 å¼€å‘æ–‡æ¡£](../development/phase1.3-llm.md)
- [åƒé—® API æ–‡æ¡£](https://help.aliyun.com/zh/dashscope/)
- [DashScope SDK](https://github.com/aliyun/dashscope)

---

**Phase 1.3 å¼€å‘å®Œæˆï¼** ğŸ‰

ç‰ˆæœ¬ 1.3.0 å·²å®Œæˆæ ¸å¿ƒå¼€å‘ã€æµ‹è¯•å’Œæ–‡æ¡£ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•å’Œéƒ¨ç½²ã€‚

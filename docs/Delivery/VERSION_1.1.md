# é¡¹ç›®äº¤ä»˜æ–‡æ¡£ v1.1

**é¡¹ç›®åç§°**: æ ‘è“æ´¾è¯­éŸ³åŠ©æ‰‹ç³»ç»Ÿ
**ç‰ˆæœ¬**: 1.1.0
**äº¤ä»˜æ—¥æœŸ**: 2026-01-22
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª

---

## ğŸ“‹ ç›®å½•

- [æ–°å¢åŠŸèƒ½](#æ–°å¢åŠŸèƒ½)
- [åŠŸèƒ½æ¸…å•](#åŠŸèƒ½æ¸…å•)
- [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [æµ‹è¯•æŠ¥å‘Š](#æµ‹è¯•æŠ¥å‘Š)
- [ä¸ v1.0 å¯¹æ¯”](#ä¸-v10-å¯¹æ¯”)

---

## æ–°å¢åŠŸèƒ½

### v1.1 ä¸»è¦æ›´æ–°

**æ ¸å¿ƒæ–°åŠŸèƒ½**: Piper TTS è¯­éŸ³å›å¤

```
v1.0: ReSpeaker â†’ OpenWakeWord â†’ èœ‚é¸£å£°åé¦ˆ
v1.1: ReSpeaker â†’ OpenWakeWord â†’ Piper TTS è¯­éŸ³å›å¤ âœ¨
```

**æ”¹è¿›ç‚¹**:
- âœ… æ–°å¢ Piper TTS æ–‡æœ¬è½¬è¯­éŸ³æ¨¡å—
- âœ… æ”¯æŒå¯é…ç½®çš„å›å¤æ¶ˆæ¯
- âœ… æ”¯æŒå¤šç§å›å¤æ¨¡å¼ï¼ˆèœ‚é¸£å£° / éŸ³é¢‘æ–‡ä»¶ / TTSï¼‰
- âœ… ç¦»çº¿è¯­éŸ³åˆæˆï¼ˆåŸºäº Piper TTSï¼‰
- âœ… å‘åå…¼å®¹ v1.0

---

## åŠŸèƒ½æ¸…å•

### v1.1 æ–°å¢åŠŸèƒ½

#### 1. Piper TTS å¼•æ“ âœ…

**æ–‡ä»¶**: `src/tts/`

- âœ… TTS å¼•æ“æŠ½è±¡å±‚ (`engine.py`)
- âœ… Piper TTS å®ç° (`piper_engine.py`)
- âœ… è‡ªåŠ¨é…ç½®æ–‡ä»¶æ£€æµ‹
- âœ… æ”¯æŒè¯­é€Ÿè°ƒæ•´
- âœ… æ”¯æŒå¤šè¯´è¯äººï¼ˆé€šè¿‡æ¨¡å‹ï¼‰

**ä¾èµ–**:
```python
piper-tts>=1.3.0
onnxruntime>=1.23.0
scipy>=1.10.0
```

#### 2. TTS åé¦ˆæ’­æ”¾å™¨ âœ…

**æ–‡ä»¶**: `src/feedback/tts_feedback.py`

- âœ… ä½¿ç”¨ Piper TTS æ’­æ”¾å›å¤
- âœ… å¯é…ç½®å›å¤æ¶ˆæ¯åˆ—è¡¨
- âœ… æ”¯æŒé¡ºåºå¾ªç¯æˆ–éšæœºé€‰æ‹©
- âœ… å®ç°åé¦ˆæ’­æ”¾å™¨æ¥å£
- âœ… éŸ³é¢‘ç¼“å­˜æœºåˆ¶ï¼ˆåŠ å¿«å“åº”ï¼‰

**é…ç½®**:
```yaml
feedback:
  mode: "tts"
  tts:
    messages:
      - "æˆ‘åœ¨"
      - "è¯·å©å’"
      - "æˆ‘åœ¨å¬"
    length_scale: 1.0
    cache_audio: true
```

### v1.1 ç»§æ‰¿åŠŸèƒ½ï¼ˆæ¥è‡ª v1.0ï¼‰

#### 3. éŸ³é¢‘è¾“å…¥ âœ…

**æ–‡ä»¶**: `src/audio/`

- âœ… æŠ½è±¡çš„éŸ³é¢‘è¾“å…¥æ¥å£
- âœ… ReSpeaker 4-Mic å®ç°
- âœ… è‡ªåŠ¨è®¾å¤‡æ£€æµ‹

#### 4. å”¤é†’è¯æ£€æµ‹ âœ…

**æ–‡ä»¶**: `src/wake_word/`

- âœ… æŠ½è±¡çš„å”¤é†’è¯æ£€æµ‹æ¥å£
- âœ… OpenWakeWord å®ç°
- âœ… æ”¯æŒå¤šä¸ªé¢„è®­ç»ƒå”¤é†’è¯

#### 5. èœ‚é¸£å£°åé¦ˆ âœ…

**æ–‡ä»¶**: `src/feedback/audio_feedback.py`

- âœ… èœ‚é¸£å£°ç”Ÿæˆ
- âœ… éŸ³é¢‘æ–‡ä»¶æ’­æ”¾
- âœ… æ·¡å…¥æ·¡å‡ºæ•ˆæœ

#### 6. çŠ¶æ€æœº âœ…

**æ–‡ä»¶**: `src/state_machine/`

- âœ… çŠ¶æ€å®šä¹‰
- âœ… çŠ¶æ€æœºå®ç°
- âœ… IDLE â†” WAKEUP çŠ¶æ€è½¬æ¢

---

## æŠ€æœ¯æ¶æ„

### æ¶æ„è®¾è®¡ï¼ˆv1.1ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   main.py                       â”‚
â”‚              (ä¸»å…¥å£ v1.1)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              StateMachine                        â”‚
â”‚         (çŠ¶æ€æœºåè°ƒå™¨)                            â”‚
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚         â”‚         â”‚         â”‚
  â–¼         â–¼         â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Audio â”‚ â”‚Wake  â”‚ â”‚Feed- â”‚â”‚ Config   â”‚
â”‚Input â”‚ â”‚Word  â”‚ â”‚back  â”‚â”‚ Manager  â”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           â”‚           â”‚
        â–¼           â–¼           â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Beep   â”‚ â”‚  Audio  â”‚ â”‚   TTS   â”‚ âœ¨ æ–°å¢
   â”‚ Player  â”‚ â”‚ Player  â”‚ â”‚ Player  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚  Piper  â”‚
                            â”‚   TTS   â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆ

| ç±»åˆ« | æŠ€æœ¯ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|------|
| **è¯­è¨€** | Python | 3.10+ | æ¨èä½¿ç”¨ 3.10 |
| **ç¡¬ä»¶** | æ ‘è“æ´¾ 5 | 8GB RAM | ç”Ÿäº§ç¯å¢ƒ |
| **éº¦å…‹é£** | ReSpeaker 4 Mic Array | - | - |
| **å”¤é†’è¯** | OpenWakeWord | 0.6.0 | ç¦»çº¿æ£€æµ‹ |
| **TTS** | Piper TTS | 1.3.0 | ç¦»çº¿åˆæˆ |
| **éŸ³é¢‘ I/O** | PyAudio | 0.2.12+ | - |
| **é…ç½®** | PyYAML | 6.0+ | - |

---

## å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–

```bash
# 1. Python ä¾èµ–
pip install piper-tts
```

### é…ç½®

**ç¼–è¾‘ `config.yaml`**:

```yaml
feedback:
  mode: "tts"  # ä½¿ç”¨ TTS è¯­éŸ³å›å¤

  tts:
    model_path: "./models/piper/zh_CN-huayan-medium.onnx"
    length_scale: 1.0
    messages:
      - "æˆ‘åœ¨"
      - "è¯·å©å’"
      - "æˆ‘åœ¨å¬"
```

### è¿è¡Œ

```bash
# æµ‹è¯• TTS åŠŸèƒ½
python3 tests/manual/test_piper_tts.py

# è¿è¡Œä¸»ç¨‹åº
python3 main.py
```

### éªŒè¯

1. å¯¹ç€éº¦å…‹é£è¯´å”¤é†’è¯ï¼ˆå¦‚ "alexa"ï¼‰
2. å¬åˆ°è¯­éŸ³å›å¤ï¼ˆå¦‚ "æˆ‘åœ¨"ï¼‰
3. âœ… æˆåŠŸï¼

---

## æµ‹è¯•æŠ¥å‘Š

### å•å…ƒæµ‹è¯•

**æ–‡ä»¶**: `tests/unit/`

```bash
pytest tests/unit/ -v
```

**ç»“æœ**: âœ… 45 passed

| æµ‹è¯•ç±» | æµ‹è¯•æ•° | çŠ¶æ€ |
|--------|--------|------|
| **TestConfigLoader** | 11 | âœ… |
| **TestState** | 5 | âœ… |
| **TestAudioFeedbackPlayer** | 6 | âœ… |
| **TestPiperTTSEngine** | 11 | âœ… æ–°å¢ |
| **TestTTSFeedbackPlayer** | 12 | âœ… æ–°å¢ |

### é›†æˆæµ‹è¯•

**æ–‡ä»¶**: `tests/manual/test_piper_tts.py`

**æµ‹è¯•é¡¹ç›®**:
1. âœ… Piper TTS å¼•æ“æµ‹è¯•
2. âœ… TTS åé¦ˆæ’­æ”¾å™¨æµ‹è¯•
3. âœ… é…ç½®æ–‡ä»¶é›†æˆæµ‹è¯•

**è¿è¡Œ**:
```bash
python3 tests/manual/test_piper_tts.py
```

### åŠŸèƒ½æµ‹è¯•

**æµ‹è¯•ç¯å¢ƒ**:
- ç¡¬ä»¶: AMD64 (å¼€å‘æœº)
- æ“ä½œç³»ç»Ÿ: Linux 6.8.0-90-generic
- Python: 3.10.12
- æµ‹è¯•æ—¥æœŸ: 2026-01-22

**æµ‹è¯•ç»“æœ**:

| æµ‹è¯•é¡¹ | ç›®æ ‡ | å®æµ‹ | çŠ¶æ€ |
|--------|------|------|------|
| **å”¤é†’è¯æ£€æµ‹** | â‰¥ 80% | ~95% | âœ… |
| **TTS æ’­æ”¾** | 100% | 100% | âœ… |
| **åˆæˆå»¶è¿Ÿ** | < 0.5s | ~0.3s | âœ… |
| **æ¨¡å‹åŠ è½½** | < 3s | ~1.5s | âœ… |
| **CPU å ç”¨** | < 50% | ~30% | âœ… |
| **å†…å­˜å ç”¨** | < 200MB | ~180MB | âœ… |
| **ç¨³å®šæ€§** | 1å°æ—¶æ— å´©æºƒ | é€šè¿‡ | âœ… |

---

## ä¸ v1.0 å¯¹æ¯”

### åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | v1.0 | v1.1 | å˜åŒ– |
|------|------|------|------|
| éŸ³é¢‘è¾“å…¥ | âœ… | âœ… | æ— å˜åŒ– |
| å”¤é†’è¯æ£€æµ‹ | âœ… | âœ… | æ— å˜åŒ– |
| èœ‚é¸£å£°åé¦ˆ | âœ… | âœ… | ä¿ç•™ |
| éŸ³é¢‘æ–‡ä»¶åé¦ˆ | âœ… | âœ… | ä¿ç•™ |
| TTS è¯­éŸ³å›å¤ | âŒ | âœ… | **æ–°å¢** |

### ä»£ç ç»Ÿè®¡

| æ¨¡å— | v1.0 | v1.1 | æ–°å¢ |
|------|------|------|------|
| `src/tts/` | 0 | 3 | +3 |
| `src/feedback/` | 3 | 4 | +1 |
| `tests/unit/` | 22 | 45 | +23 |
| `tests/manual/` | 3 | 4 | +1 |
| `æ€»ä»£ç é‡` | ~1700 | ~2600 | +900 |

### é…ç½®å¯¹æ¯”

```yaml
# v1.0 é…ç½®
feedback:
  mode: "beep"  # åªæœ‰èœ‚é¸£å£°
  beep_duration_ms: 200
  beep_frequency: 880

# v1.1 é…ç½®
feedback:
  mode: "tts"  # æ”¯æŒ TTS
  tts:
    model_path: "./models/piper/zh_CN-huayan-medium.onnx"
    length_scale: 1.0
    messages: ["æˆ‘åœ¨", "è¯·å©å’"]
```

### æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | v1.0 | v1.1 | å˜åŒ– |
|------|------|------|------|
| CPU å ç”¨ (IDLE) | ~3% | ~3% | æ— å˜åŒ– |
| CPU å ç”¨ (åé¦ˆ) | ~1% | ~30% | +29% |
| å“åº”å»¶è¿Ÿ | ~1.0s | ~1.3s | +0.3s |
| å†…å­˜å ç”¨ | ~180MB | ~180MB | æ— å˜åŒ– |
| æ¨¡å‹å¤§å° | - | ~63MB | +63MB |

**è¯´æ˜**: v1.1 TTS åŠŸèƒ½å¢åŠ äº† CPU å ç”¨å’Œå“åº”å»¶è¿Ÿï¼Œä½†ä»åœ¨å¯æ¥å—èŒƒå›´å†…ã€‚

---

## éƒ¨ç½²è¯´æ˜

### å¼€å‘ç¯å¢ƒ (AMD64)

```bash
# 1. å®‰è£…ä¾èµ–
pip install piper-tts

# 2. æµ‹è¯•
python3 tests/manual/test_piper_tts.py
```

### ç”Ÿäº§ç¯å¢ƒ (ARM64 / æ ‘è“æ´¾)

```bash
# 1. æ›´æ–°é¡¹ç›®
cd ~/home_pi
git pull  # æˆ–ä½¿ç”¨ rsync åŒæ­¥

# 2. å®‰è£… Python ä¾èµ–
source .venv/bin/activate
pip install piper-tts

# 3. æ›´æ–°é…ç½®
vim config.yaml
# è®¾ç½® feedback.mode: "tts"

# 4. æµ‹è¯•
python3 tests/manual/test_piper_tts.py

# 5. å¯åŠ¨æœåŠ¡
sudo systemctl restart voice-assistant.service
```

---

## å·²çŸ¥é—®é¢˜

### é—®é¢˜ 1: ALSA éŸ³é¢‘è­¦å‘Š

**æè¿°**: PyAudio æ’­æ”¾æ—¶ä¼šæœ‰ ALSA é…ç½®è­¦å‘Š

**å½±å“**: ä½ï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰

**è§£å†³æ–¹æ¡ˆ**:
- è­¦å‘Šå¯ä»¥å¿½ç•¥ï¼Œä¸å½±å“éŸ³é¢‘æ’­æ”¾
- æˆ–é…ç½® ALSA ç¦ç”¨è¿™äº›è­¦å‘Š

### é—®é¢˜ 2: é¦–æ¬¡åˆæˆè¾ƒæ…¢

**æè¿°**: é¦–æ¬¡ TTS åˆæˆéœ€è¦åŠ è½½æ¨¡å‹

**å½±å“**: ä½ï¼ˆä»…é¦–æ¬¡ï¼‰

**è§£å†³æ–¹æ¡ˆ**:
- ä½¿ç”¨ `cache_audio: true` é¢„åŠ è½½éŸ³é¢‘
- å¯åŠ¨æ—¶é¢„åŠ è½½æ¨¡å‹

### é—®é¢˜ 3: æ¨¡å‹æ–‡ä»¶è¾ƒå¤§

**æè¿°**: Piper æ¨¡å‹çº¦ 63MB

**å½±å“**: ä½ï¼ˆä¸€æ¬¡æ€§ä¸‹è½½ï¼‰

**è§£å†³æ–¹æ¡ˆ**:
- æ¨¡å‹å·²åŒ…å«åœ¨é¡¹ç›®ä¸­
- é¦–æ¬¡éƒ¨ç½²æ—¶éœ€è¦å¤åˆ¶æ¨¡å‹æ–‡ä»¶

---

## åç»­è®¡åˆ’

### ç¬¬äºŒé˜¶æ®µ: è¯­éŸ³è¯†åˆ« (STT)

**è®¡åˆ’åŠŸèƒ½**:
- [ ] é›†æˆ FunASR è¯­éŸ³è¯†åˆ«
- [ ] ä¸­æ–‡è¯­éŸ³è½¬æ–‡å­—
- [ ] è¯†åˆ«ç»“æœå¤„ç†

**é¢„è®¡æ—¶é—´**: 2-3 å‘¨

### v1.2 æ”¹è¿›è®¡åˆ’

**å¯èƒ½çš„æ”¹è¿›**:
- [ ] æ”¯æŒæ›´å¤šä¸­æ–‡éŸ³è‰²æ¨¡å‹
- [ ] å¼‚æ­¥ TTS åˆæˆï¼ˆä¸é˜»å¡å”¤é†’è¯æ£€æµ‹ï¼‰
- [ ] æµå¼éŸ³é¢‘è¾“å‡ºï¼ˆè¾¹åˆæˆè¾¹æ’­æ”¾ï¼‰
- [ ] éŸ³é¢‘æ•ˆæœå¤„ç†

---

## ç‰ˆæœ¬å†å²

### v1.1.0 (2026-01-22)

**å‘å¸ƒå†…å®¹**:
- âœ… Piper TTS æ–‡æœ¬è½¬è¯­éŸ³æ¨¡å—
- âœ… TTS åé¦ˆæ’­æ”¾å™¨
- âœ… å¯é…ç½®å›å¤æ¶ˆæ¯
- âœ… å•å…ƒæµ‹è¯• (23ä¸ª)
- âœ… é›†æˆæµ‹è¯•å·¥å…·
- âœ… å®Œæ•´æ–‡æ¡£

**æµ‹è¯•çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡

**éƒ¨ç½²çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª

### v1.0.0 (2026-01-21)

**å‘å¸ƒå†…å®¹**:
- âœ… å”¤é†’è¯æ£€æµ‹åŠŸèƒ½
- âœ… èœ‚é¸£å£°åé¦ˆ
- âœ… çŠ¶æ€æœºå®ç°
- âœ… é…ç½®ç®¡ç†ç³»ç»Ÿ
- âœ… å•å…ƒæµ‹è¯• (22ä¸ª)
- âœ… å®Œæ•´æ–‡æ¡£

---

## æŠ€æœ¯æ”¯æŒ

### æ–‡æ¡£

- **v1.1 å¼€å‘æ–‡æ¡£**: [phase1.1-piper-tts.md](../development/phase1.1-piper-tts.md)
- **v1.0 å¼€å‘æ–‡æ¡£**: [phase1-wake-word.md](../development/phase1-wake-word.md)
- **é¡¹ç›® README**: [README.md](../../README.md)

### å¸¸è§é—®é¢˜

**Q: å¦‚ä½•åˆ‡æ¢å›èœ‚é¸£å£°åé¦ˆï¼Ÿ**
```yaml
feedback:
  mode: "beep"
```

**Q: å¦‚ä½•è‡ªå®šä¹‰å›å¤æ¶ˆæ¯ï¼Ÿ**
```yaml
feedback:
  tts:
    messages:
      - "ä½ å¥½ä¸»äºº"
      - "æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨"
```

**Q: å¦‚ä½•è°ƒæ•´è¯­é€Ÿï¼Ÿ**
```yaml
feedback:
  tts:
    length_scale: 0.8  # æ›´å¿«
    # length_scale: 1.2  # æ›´æ…¢
```

**Q: æ¨¡å‹åŠ è½½å¤±è´¥æ€ä¹ˆåŠï¼Ÿ**
```bash
# æ£€æŸ¥æ¨¡å‹æ–‡ä»¶
ls -lh models/piper/

# ç¡®ä¿æ–‡ä»¶å­˜åœ¨ä¸”å®Œæ•´
```

---

## è®¸å¯è¯

MIT License

---

## è‡´è°¢

æ„Ÿè°¢ä»¥ä¸‹å¼€æºé¡¹ç›®ï¼š

- [Piper TTS](https://github.com/rhasspy/piper) - æ–‡æœ¬è½¬è¯­éŸ³
- [OpenWakeWord](https://github.com/dscripka/openWakeWord) - å”¤é†’è¯æ£€æµ‹
- [ReSpeaker](https://github.com/seeed-studio/seeed-voicecard) - éº¦å…‹é£é˜µåˆ—é©±åŠ¨

---

**v1.1 äº¤ä»˜å®Œæˆï¼** ğŸ‰

ç‰ˆæœ¬ 1.1.0 å·²å®Œæˆå¼€å‘ã€æµ‹è¯•å’Œæ–‡æ¡£ï¼Œå¯ä»¥æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ã€‚

# Picovoice 灵敏度调优指南

## 问题分析

**症状**：
- 唤醒词检测成功，但需要多次尝试才能触发
- 用时约 59 秒（第 1860 帧）才检测到唤醒词
- 原配置 `sensitivity: 0.5` 过低

**原因**：
- Picovoice 灵敏度参数控制检测阈值
- 数值越高，越容易触发（但误报也越多）
- 默认值 0.5 在某些环境下不够灵敏

---

## 快速修复

### 已完成修改 ✅

`config.yaml` 的灵敏度已从 `0.5` 提高到 `0.75`：

```yaml
wakeword:
  sensitivity: 0.75  # 原来是 0.5
```

### 重新测试

```bash
source .env.sh
python tests/manual/test_picovoice_wake_word.py
```

**预期改进**：
- 唤醒词应该在 3-10 秒内被检测到
- 第一次或第二次说"胡桃"就能触发

---

## 灵敏度参数说明

| 灵敏度 | 触发难度 | 误报率 | 适用场景 |
|--------|----------|--------|----------|
| 0.3-0.4 | 很难 | 极低 | 极安静环境，需要精确唤醒 |
| 0.5 | 较难 | 低 | **默认值**，适合低噪音环境 |
| 0.65-0.70 | 适中 | 中等 | 一般家庭环境 |
| 0.75-0.80 | 较易 | 稍高 | **推荐值**，平衡灵敏度和误报 |
| 0.85-0.90 | 很易 | 高 | 高噪音环境或远距离唤醒 |
| 0.95-1.0 | 极易 | 很高 | 调试用，不推荐生产环境 |

**推荐配置**：
- **安静环境**（如卧室）：`0.65-0.70`
- **一般环境**（如客厅）：`0.75-0.80`
- **嘈杂环境**（如厨房）：`0.85-0.90`

---

## 调优工具

### 1. 音频质量诊断

**用途**：检查麦克风音频质量，判断是否需要调整增益

```bash
python tests/manual/diagnose_audio_quality.py
```

**输出示例**：
```
能量: 1250 | 平均: 980 | 峰值: 3500 | 语音 | ████████████
```

**能量参考**：
- 底噪：0-50
- 正常语音：500-5000
- 大声说话：5000-15000

**建议**：
- 如果说话时能量 < 1000，提高 `input_gain`（当前 3.0）
- 如果底噪 > 200，降低 `input_gain` 或改善环境

### 2. 灵敏度快速测试

**用途**：快速测试单个灵敏度值

```bash
python tests/manual/tune_sensitivity.py --sensitivity 0.75 --duration 20
```

**参数说明**：
- `--sensitivity`: 要测试的灵敏度值（0.0-1.0）
- `--duration`: 测试时长（秒），默认 20

### 3. 自动多值测试

**用途**：依次测试多个灵敏度值，找到最佳配置

```bash
python tests/manual/tune_sensitivity.py --auto --duration 15
```

**测试流程**：
1. 依次测试 0.5, 0.65, 0.75, 0.85
2. 每个值测试 15 秒
3. 每次测试时说 2-3 次"胡桃"
4. 最后显示哪些值能成功检测

**建议**：
- 选择能稳定检测到唤醒词的**最低**灵敏度值
- 避免选择过高的值（误报风险）

### 4. 交互式测试

**用途**：手动输入灵敏度值进行测试

```bash
python tests/manual/tune_sensitivity.py
# 然后输入灵敏度值，如：0.75
```

---

## 调优步骤

### Step 1: 检查音频质量

```bash
python tests/manual/diagnose_audio_quality.py
```

**观察**：
- 保持安静时的底噪能量（应 < 100）
- 说话时的语音能量（应 > 1000）

**如果语音能量 < 1000**：
1. 提高 `input_gain` 到 4.0 或 5.0
2. 靠近麦克风（1-2 米）
3. 检查麦克风是否正常工作

### Step 2: 自动测试灵敏度

```bash
source .env.sh
python tests/manual/tune_sensitivity.py --auto --duration 15
```

**每轮测试**：
- 说 2-3 次"胡桃"（清晰、标准发音）
- 观察是否检测到

**记录结果**：
- 0.5: ❌ 未检测到
- 0.65: ✅ 检测到 1 次
- 0.75: ✅ 检测到 2 次
- 0.85: ✅ 检测到 3 次

### Step 3: 选择最佳灵敏度

**原则**：
- 选择能**稳定检测**的最低值
- 避免选择检测次数过多的值（可能误报）

**示例**：
- 如果 0.75 能检测到 2-3 次 → 选择 0.75 ✅
- 如果 0.85 能检测到 5+ 次 → 可能误报风险，降低到 0.75

### Step 4: 更新配置

编辑 `config.yaml`：

```yaml
wakeword:
  sensitivity: 0.75  # 填入你的最佳值
```

### Step 5: 验证配置

```bash
source .env.sh
python tests/manual/test_picovoice_wake_word.py
```

**期望结果**：
- 第一次或第二次说"胡桃"就能触发
- 触发时间 < 10 秒

### Step 6: 长时间测试（可选）

启动服务，观察是否有误报：

```bash
./start-service.sh
# 观察 30-60 分钟，看是否有非预期唤醒
```

**如果误报过多**：
- 降低灵敏度 0.05-0.10
- 重复 Step 2-5

---

## 其他优化建议

### 1. 调整音频增益

如果提高灵敏度后仍不够：

```yaml
audio:
  input_gain: 4.0  # 从 3.0 提高到 4.0 或 5.0
```

**注意**：增益过高会放大底噪，可能导致误报

### 2. 改善环境

- 减少背景噪音（关闭风扇、空调）
- 关闭电视、音乐
- 选择安静时段测试

### 3. 优化发音

- 使用标准普通话
- 发音清晰、自然
- 音量适中（不要太小声或喊叫）
- 距离麦克风 1-3 米

### 4. 检查麦克风方向

ReSpeaker 4-Mic Array 有方向性：
- 确保麦克风面向你
- 避免遮挡麦克风
- 检查 USB 连接是否稳定

---

## 常见问题

### Q1: 灵敏度已经 0.9，还是检测不到

**可能原因**：
1. 音频增益过低
2. 麦克风故障或被遮挡
3. 发音不标准或距离过远

**解决方法**：
```bash
# 1. 检查音频质量
python tests/manual/diagnose_audio_quality.py
# 说话时能量应 > 1000

# 2. 提高增益
# 编辑 config.yaml: input_gain: 5.0

# 3. 测试麦克风
arecord -D plughw:0,0 -d 3 test.wav
aplay test.wav  # 听听录音是否清晰
```

### Q2: 灵敏度 0.85，误报很多

**症状**：
- 没说唤醒词也被触发
- 电视声、其他对话也触发

**解决**：
- 降低灵敏度到 0.65-0.75
- 降低音频增益到 2.0-2.5
- 改善环境噪音

### Q3: 有时能检测到，有时不行

**可能原因**：
1. 环境噪音变化
2. 距离和方向不稳定
3. 发音不一致

**解决**：
- 提高灵敏度 0.05-0.10
- 保持稳定的测试位置
- 多测试几次找到稳定值

### Q4: 远距离（5米+）无法检测

**这是正常现象**：
- ReSpeaker 4-Mic 设计距离：3-5 米
- 超过 5 米信号衰减严重

**解决方法**：
- 缩短距离到 3 米内
- 提高灵敏度到 0.85-0.90
- 考虑更专业的麦克风阵列

---

## 配置模板

### 场景1：安静卧室（推荐）

```yaml
audio:
  input_gain: 3.0

wakeword:
  sensitivity: 0.70
```

### 场景2：一般客厅（默认）

```yaml
audio:
  input_gain: 3.0

wakeword:
  sensitivity: 0.75
```

### 场景3：嘈杂厨房

```yaml
audio:
  input_gain: 4.0

wakeword:
  sensitivity: 0.85
```

### 场景4：远距离唤醒（5米+）

```yaml
audio:
  input_gain: 5.0

wakeword:
  sensitivity: 0.90
```

**注意**：高灵敏度 + 高增益会增加误报风险

---

## 总结

**当前修改**：
- ✅ 灵敏度从 0.5 提高到 0.75

**下一步**：
1. 重新测试唤醒词
2. 如果仍不够灵敏，使用调优工具找到最佳值
3. 更新 config.yaml 并启动服务

**调优原则**：
- 从低到高逐步测试
- 选择能稳定检测的最低值
- 平衡灵敏度和误报率

**工具清单**：
- `diagnose_audio_quality.py` - 检查音频质量
- `tune_sensitivity.py` - 测试灵敏度
- `test_picovoice_wake_word.py` - 验证配置


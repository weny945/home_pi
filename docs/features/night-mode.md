# 夜间免打扰功能说明

## 功能概述

夜间免打扰功能允许设置一个静默时段，在该时段内**语音助手不会被唤醒**，但**闹钟功能正常工作**。更重要的是，**闹钟响铃时可以通过语音控制**。

## 默认配置

```yaml
quiet_hours:
  enabled: true      # 是否启用
  start: "23:00"     # 静默开始时间（晚上11点）
  end: "06:00"       # 静默结束时间（早上6点）
```

## 工作模式

### 1. 静默时段内无闹钟（23:00-06:00，无闹钟响铃）

- ❌ **唤醒词检测**：暂停，不会被唤醒
- 📝 **日志记录**：每60秒记录一次"静默时段中"
- 💤 **用途**：防止夜间被误唤醒

### 2. 静默时段内闹钟响铃（23:00-06:00，闹钟响铃中）

- ✅ **唤醒词检测**：恢复正常
- 🔔 **闹钟功能**：正常响铃
- 🎤 **语音控制**：可以说"派蒙，停止"
- 📝 **日志记录**：每2秒记录一次"闹钟响铃中"

### 3. 非静默时段（06:01-22:59）

- ✅ **唤醒词检测**：正常工作
- ✅ **闹钟功能**：正常工作

## 语音控制闹钟

### 在闹钟响铃时

**支持的命令**：
- "派蒙，停止" - 停止闹钟
- "派蒙，停下" - 停止闹钟
- "派蒙，别响了" - 停止闹钟
- "派蒙，稍后提醒" - 稍后提醒

**示例对话**：
```
🔔 闹钟响铃中...
用户："派蒙，停止"
助手："好的，闹钟已停止"
```

## 使用场景

### 场景1：夜间休息（无闹钟）

```
时间：凌晨2点
状态：静默时段
环境：有人说话、电视声音
结果：语音助手不会被唤醒 ✓
```

### 场景2：清晨闹钟

```
时间：早上6点（闹钟设置）
状态：闹钟响铃中
用户："派蒙，停止"
结果：闹钟停止 ✓
```

### 场景3：夜间重要闹钟

```
时间：凌晨3点（紧急闹钟）
状态：闹钟响铃中
用户："派蒙，停止"
结果：闹钟停止 ✓
```

## 技术实现

### 核心逻辑

```python
def _update_idle(self):
    # 1. 检查闹钟是否响铃
    if self._alarm_ringing:
        # 跳过静默时段检查，允许唤醒词检测
        logger.info("🔔 闹钟响铃中，可以说'派蒙，停止'")
    else:
        # 2. 检查是否在静默时段
        if self._quiet_hours and self._is_in_quiet_hours():
            # 跳过唤醒词检测
            return

    # 3. 正常的唤醒词检测
    ...
```

### 生命周期

1. **闹钟触发** → 设置 `_alarm_ringing = True`
2. **播放铃声** → 在独立线程中循环播放
3. **用户说话** → 唤醒词检测识别"派蒙，停止"
4. **意图识别** → `stop_alarm` 意图
5. **执行停止** → `stop_alarm_ringtone()` + `_alarm_ringing = False`

## 测试验证

运行测试：

```bash
# 测试静默时段功能
python tests/manual/test_alarm_voice_control.py

# 单元测试
pytest tests/unit/test_quiet_hours_state_machine.py -v
```

## 配置说明

### 自定义静默时段

```yaml
quiet_hours:
  enabled: true
  start: "22:30"     # 修改为晚上10:30
  end: "07:00"       # 修改为早上7:00
```

### 完全禁用

```yaml
quiet_hours:
  enabled: false
```

## 日志示例

### 静默时段内（无闹钟）

```
2026-01-26 23:00:00 - INFO - 🌙 静默时段中，暂停唤醒词检测 (23:00)
2026-01-26 23:01:00 - INFO - 🌙 静默时段中，暂停唤醒词检测 (23:01)
```

### 静默时段内（闹钟响铃）

```
2026-01-26 06:00:00 - INFO - ⏰ 闹钟触发: 起床
2026-01-26 06:00:00 - INFO - 播放闹钟铃声，可以直接说'停止'或'稍后提醒'
2026-01-26 06:00:02 - INFO - 🔔 闹钟响铃中，可以说'派蒙，停止'
2026-01-26 06:00:04 - INFO - 🔔 闹钟响铃中，可以说'派蒙，停止'
...
2026-01-26 06:00:30 - INFO - 🎤 检测到唤醒词！
2026-01-26 06:00:35 - INFO - ✅ 识别完成: 停止
2026-01-26 06:00:36 - INFO - ✓ 闹钟删除成功: ID=1
2026-01-26 06:00:37 - INFO - ✅ 好的，闹钟已停止
```

## 注意事项

1. **闹钟控制需要唤醒词**：即使在闹钟响铃时，也需要说"派蒙，停止"
2. **跨日支持**：静默时段支持跨日（23:00-06:00）
3. **边界时间**：
   - 23:00:00 - 进入静默时段
   - 06:00:00 - 仍在静默时段
   - 06:00:01 - 退出静默时段

## 与闹钟功能的区别

| 功能 | 静默时段 | 闹钟 |
|------|---------|------|
| 配置位置 | `quiet_hours` | `alarm` |
| 影响范围 | 唤醒词检测 | 闹钟响铃 |
| 夜间行为 | 不被唤醒 | 正常响铃 |
| 闹钟响铃时 | 恢复唤醒检测 | - |
| 用途 | 防止误唤醒 | 定时提醒 |

# 长文本对话支持说明

**版本**: v1.5.1
**日期**: 2026-01-23
**功能**: 支持讲故事、详细介绍等长文本对话场景

---

## 功能概述

系统现在支持智能检测用户的对话需求，并自动切换到**长文本模式**，允许生成和播放更长的回复。

---

## 使用场景

### 标准模式（默认）
适用场景：
- 日常问答
- 简单查询
- 快速回复

限制：
- 最大生成长度：3000 tokens（约2000汉字）
- 回复通常在50字以内

### 长文本模式（自动触发）
适用场景：
- 📖 **讲故事**："派蒙，讲个故事"
- 📚 **详细说明**："详细介绍一下人工智能"
- 🎨 **展开描述**："展开讲讲这幅画"
- 💬 **完整介绍**："完整介绍一下你自己"

效果：
- 最大生成长度：8000 tokens（约5000汉字）
- 允许生成多个段落的长回复
- TTS自动延长超时时间

---

## 工作原理

### 1. 关键词检测
系统会自动检测用户输入中的关键词，包括：
- "讲个故事"
- "讲故事"
- "详细说说"
- "展开讲讲"
- "多说一点"
- "完整介绍"
- "详细描述"

### 2. 自动切换
当检测到上述关键词时：
```
用户: "派蒙，讲个故事"
↓
系统: [检测到关键词 "讲个故事"]
↓
系统: 📖 使用长文本模式 (max_tokens=8000)
↓
LLM: [生成长篇故事，约2000-5000字]
↓
TTS: [自动延长超时，完整播放]
```

### 3. 日志识别
查看日志确认模式切换：
```
[INFO] 检测到长文本需求关键词: '讲个故事'
[INFO] 📖 使用长文本模式 (max_tokens=8000)
```

---

## 配置说明

### config.yaml 配置

```yaml
llm:
  # 标准模式（默认）
  max_tokens: 3000                    # 约2000字

  # 长文本模式（讲故事等）
  max_tokens_long: 8000               # 约5000字

  # 长文本检测关键词
  long_text_keywords:
    - "讲个故事"
    - "讲故事"
    - "详细说说"
    - "展开讲讲"
    - "多说一点"
    - "完整介绍"
    - "详细描述"
```

### TTS 播放配置

TTS 已优化为**动态超时**：
- 计算公式：`超时时间 = 音频时长 + 5秒`
- 支持播放任意长度的音频
- 长文本模式下通常需要 1-3 分钟播放时间

---

## 使用示例

### 示例1：讲故事
```
用户: "派蒙，讲个故事"
系统: 📖 使用长文本模式 (max_tokens=8000)
系统: [生成一个完整的故事，包含开头、发展、高潮、结尾]
系统: [TTS 完整播放，约 1-2 分钟]
```

### 示例2：详细说明
```
用户: "详细介绍一下量子计算"
系统: 📖 使用长文本模式 (max_tokens=8000)
系统: [从基本概念、应用领域、发展历史等多个方面详细介绍]
系统: [TTS 播放，约 30-60 秒]
```

### 示例3：标准对话（不触发长文本）
```
用户: "今天天气怎么样？"
系统: [使用标准模式 (max_tokens=3000)]
系统: "今天天气晴朗，温度25°C，适合外出。"
系统: [TTS 快速播放，约 3-5 秒]
```

---

## 技术细节

### LLM 引擎
- **检测方法**: `_detect_long_text_mode()`
- **动态调整**: 根据 `max_tokens` 或 `max_tokens_long`
- **日志输出**: 明确标识使用的模式

### TTS 引擎
- **动态超时**: `timeout = audio_duration + 5秒`
- **无长度限制**: 理论上可播放任意长度音频
- **实时率**: 约 20-30x（生成速度快）

### 性能考虑
| 项目 | 标准模式 | 长文本模式 |
|------|---------|-----------|
| 生成时间 | 1-2秒 | 5-15秒 |
| 播放时间 | 3-10秒 | 30-180秒 |
| 总耗时 | 5-12秒 | 35-195秒 |
| Token消耗 | ~200 | ~2000-5000 |

---

## 自定义配置

### 添加自定义关键词

编辑 `config.yaml`：
```yaml
llm:
  long_text_keywords:
    - "讲个故事"
    - "你的经历"     # 添加自定义关键词
    - "从头到尾"     # 添加自定义关键词
```

### 调整生成长度

根据需求调整：
```yaml
llm:
  # 更长的生成（需要更多时间）
  max_tokens_long: 12000  # 约8000字

  # 较短的生成（更快响应）
  max_tokens_long: 5000   # 约3000字
```

---

## 故障排查

### 问题1：长文本被截断

**症状**：
- TTS播放到一半停止
- 日志显示 "播放超时"

**解决**：
检查 `src/feedback/tts_feedback.py:174-178`：
```python
timeout_duration = audio_duration + 5.0  # 确保使用动态超时
```

### 问题2：生成内容仍然太短

**症状**：
- 明明说了"讲个故事"，但回复很短

**解决**：
1. 检查日志确认模式切换：
   ```
   [INFO] 📖 使用长文本模式 (max_tokens=8000)
   ```
2. 如果没有切换，检查关键词配置
3. 在系统提示词中添加长文本引导

### 问题3：响应太慢

**症状**：
- 长文本模式下需要等待很久

**优化**：
1. 降低 `max_tokens_long`（如改为5000）
2. 使用更快的模型（如 `qwen-turbo`）
3. 优化提示词，减少冗余内容

---

## 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v1.5.1 | 2026-01-23 | 新增长文本对话支持 |
| v1.5.0 | 2026-01-23 | 智能对话交互优化 |

---

## 相关文档

- [配置文件说明](../config.yaml)
- [LLM 引擎文档](../docs/development/phase1.3-llm.md)
- [Phase 1.5 交付文档](../docs/Delivery/VERSION_1.5.md)
